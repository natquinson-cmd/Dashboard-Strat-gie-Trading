<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Trading â€” Performance Strategies</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

  :root {
    --bg-primary: #0a0e1a;
    --bg-card: #111827;
    --bg-card-hover: #1a2235;
    --border: #1e2a3a;
    --text-primary: #f0f4f8;
    --text-secondary: #8899aa;
    --accent-dax: #6366f1;
    --accent-dax-light: #818cf8;
    --accent-nas: #06b6d4;
    --accent-nas-light: #22d3ee;
    --accent-merged: #a78bfa;
    --positive: #10b981;
    --negative: #ef4444;
    --gradient-dax: linear-gradient(135deg, #6366f1, #818cf8);
    --gradient-nas: linear-gradient(135deg, #06b6d4, #22d3ee);
    --gradient-merged: linear-gradient(135deg, #8b5cf6, #a78bfa);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    overflow-x: hidden;
  }

  .dashboard { max-width: 1440px; margin: 0 auto; padding: 32px 40px; }

  /* Header */
  .header { text-align: center; margin-bottom: 32px; position: relative; }
  .header::after {
    content: ''; position: absolute; bottom: -16px; left: 50%; transform: translateX(-50%);
    width: 120px; height: 3px;
    background: linear-gradient(90deg, var(--accent-dax), var(--accent-nas));
    border-radius: 3px;
  }
  .header h1 {
    font-size: 2.2rem; font-weight: 800; letter-spacing: -0.5px;
    background: linear-gradient(135deg, #f0f4f8 0%, #8899aa 100%);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    margin-bottom: 8px;
  }
  .header p { color: var(--text-secondary); font-size: 0.95rem; }

  /* TAB SYSTEM */
  .tab-bar {
    display: flex; justify-content: center; gap: 6px;
    margin: 36px 0 32px; position: relative;
  }
  .tab-btn {
    padding: 12px 32px; border-radius: 12px;
    border: 1px solid var(--border); background: var(--bg-card);
    color: var(--text-secondary); font-family: inherit;
    font-size: 0.88rem; font-weight: 600; cursor: pointer;
    transition: all 0.25s; position: relative; overflow: hidden;
  }
  .tab-btn:hover { background: var(--bg-card-hover); color: var(--text-primary); }
  .tab-btn.active {
    background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(6,182,212,0.15));
    border-color: var(--accent-dax); color: var(--text-primary);
    box-shadow: 0 0 20px rgba(99,102,241,0.15);
  }
  .tab-btn.active::after {
    content: ''; position: absolute; bottom: 0; left: 20%; right: 20%;
    height: 2px; background: linear-gradient(90deg, var(--accent-dax), var(--accent-nas));
    border-radius: 2px;
  }
  .tab-btn .tab-sub {
    display: block; font-size: 0.68rem; font-weight: 400;
    color: var(--text-secondary); margin-top: 2px;
  }
  .tab-content { display: none; }
  .tab-content.active { display: block; animation: fadeIn 0.35s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes holoShift {
    0%   { background-position: 0% 50%; }
    50%  { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  @keyframes holoBorder {
    0%   { border-color: rgba(99,102,241,0.3); }
    33%  { border-color: rgba(6,182,212,0.3); }
    66%  { border-color: rgba(16,185,129,0.3); }
    100% { border-color: rgba(99,102,241,0.3); }
  }
  @keyframes holoGlow {
    0%   { box-shadow: 0 0 15px rgba(99,102,241,0.12), 0 0 35px rgba(6,182,212,0.06); }
    33%  { box-shadow: 0 0 20px rgba(6,182,212,0.16), 0 0 45px rgba(16,185,129,0.08); }
    66%  { box-shadow: 0 0 18px rgba(16,185,129,0.14), 0 0 40px rgba(167,139,250,0.07); }
    100% { box-shadow: 0 0 15px rgba(99,102,241,0.12), 0 0 35px rgba(6,182,212,0.06); }
  }
  @keyframes slideUp { from { opacity:0; transform:translateY(16px); } to { opacity:1; transform:translateY(0); } }
  @keyframes shimmer {
    0%   { background-position: -200% 0; }
    100% { background-position: 200% 0; }
  }

  /* â•â•â•â•â•â•â•â•â•â•â• TRAVELING LIGHT on card borders â•â•â•â•â•â•â•â•â•â•â• */
  @keyframes borderLight {
    0%   { --light-angle: 0deg; }
    100% { --light-angle: 360deg; }
  }
  @property --light-angle {
    syntax: '<angle>';
    initial-value: 0deg;
    inherits: false;
  }
  .hero-card, .kpi-card, .chart-card, .capital-selector {
    position: relative;
  }
  .hero-card::after, .kpi-card::after, .chart-card::after, .capital-selector::after {
    content: '';
    position: absolute;
    inset: -1px;
    border-radius: inherit;
    padding: 1px;
    background: conic-gradient(
      from var(--light-angle),
      transparent 0%,
      transparent 70%,
      rgba(99,102,241,0.6) 76%,
      rgba(6,182,212,0.8) 80%,
      rgba(16,185,129,0.6) 84%,
      transparent 90%,
      transparent 100%
    );
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    animation: borderLight 6s linear infinite;
    pointer-events: none;
    z-index: 1;
  }
  .hero-card.capital::after {
    animation: borderLight 4s linear infinite;
    background: conic-gradient(
      from var(--light-angle),
      transparent 0%,
      transparent 65%,
      rgba(16,185,129,0.7) 72%,
      rgba(6,182,212,0.9) 78%,
      rgba(99,102,241,0.7) 84%,
      rgba(167,139,250,0.5) 88%,
      transparent 95%,
      transparent 100%
    );
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
  }
  /* Stagger the light rotation per card for variety */
  .kpi-grid .kpi-card:nth-child(2)::after { animation-delay: -1s; }
  .kpi-grid .kpi-card:nth-child(3)::after { animation-delay: -2s; }
  .kpi-grid .kpi-card:nth-child(4)::after { animation-delay: -3s; }
  .kpi-grid .kpi-card:nth-child(5)::after { animation-delay: -4s; }
  .kpi-grid .kpi-card:nth-child(6)::after { animation-delay: -5s; }
  .hero-kpi .hero-card:nth-child(2)::after { animation-delay: -2s; }
  .hero-kpi .hero-card:nth-child(3)::after { animation-delay: -4s; }
  .chart-row .chart-card:nth-child(2)::after { animation-delay: -3s; }
  .kpi-card .stripe {
    background-size: 200% 100%;
    animation: shimmer 3s linear infinite;
  }
  .kpi-grid .kpi-card { animation: holoBorder 8s ease infinite, holoGlow 6s ease infinite, slideUp 0.5s ease backwards; }
  .kpi-grid .kpi-card:nth-child(1) { animation-delay: 0s, 0s, 0.05s; }
  .kpi-grid .kpi-card:nth-child(2) { animation-delay: 0.5s, 0.5s, 0.1s; }
  .kpi-grid .kpi-card:nth-child(3) { animation-delay: 1s, 1s, 0.15s; }
  .kpi-grid .kpi-card:nth-child(4) { animation-delay: 1.5s, 1.5s, 0.2s; }
  .kpi-grid .kpi-card:nth-child(5) { animation-delay: 2s, 2s, 0.25s; }
  .kpi-grid .kpi-card:nth-child(6) { animation-delay: 2.5s, 2.5s, 0.3s; }
  .hero-kpi .hero-card:nth-child(1) { animation-delay: 0s, 0s; }
  .hero-kpi .hero-card:nth-child(2) { animation-delay: 0.4s, 0.3s; }
  .hero-kpi .hero-card:nth-child(3) { animation-delay: 0.8s, 0.6s; }

  /* â•â•â•â•â•â•â•â•â•â•â• CAPITAL SELECTOR â•â•â•â•â•â•â•â•â•â•â• */
  .capital-selector {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 22px 28px 18px;
    margin-bottom: 16px;
    animation: holoBorder 10s ease infinite, holoGlow 8s ease infinite;
  }
  .capital-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 14px;
    flex-wrap: wrap;
    gap: 12px;
  }
  .capital-header h3 {
    font-size: 0.9rem; font-weight: 600; color: var(--text-primary);
    display: flex; align-items: center; gap: 8px;
  }
  .capital-header h3 .c-icon {
    width: 28px; height: 28px; border-radius: 8px;
    display: inline-flex; align-items: center; justify-content: center;
    font-size: 14px;
    background: rgba(16,185,129,0.12);
  }
  .capital-value-display {
    display: flex; align-items: center; gap: 16px; flex-wrap: wrap;
  }
  .capital-amount {
    font-size: 1.5rem; font-weight: 800; letter-spacing: -0.5px;
    background: linear-gradient(135deg, #10b981, #34d399);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .capital-detail {
    font-size: 0.78rem; color: var(--text-secondary); font-weight: 500;
  }
  .capital-slider-wrap {
    position: relative; padding: 0 2px;
  }
  .capital-slider {
    -webkit-appearance: none; appearance: none;
    width: 100%; height: 6px;
    background: rgba(30,42,58,0.8);
    border-radius: 3px; outline: none;
    cursor: pointer;
  }
  .capital-slider::-webkit-slider-thumb {
    -webkit-appearance: none; appearance: none;
    width: 24px; height: 24px;
    border-radius: 50%;
    background: var(--bg-primary);
    border: 3px solid #34d399;
    cursor: grab;
    box-shadow: 0 0 10px rgba(16,185,129,0.3);
    transition: transform 0.12s, box-shadow 0.12s;
  }
  .capital-slider::-webkit-slider-thumb:hover {
    transform: scale(1.15);
    box-shadow: 0 0 18px rgba(16,185,129,0.5);
  }
  .capital-slider::-moz-range-thumb {
    width: 24px; height: 24px;
    border-radius: 50%;
    background: var(--bg-primary);
    border: 3px solid #34d399;
    cursor: grab;
    box-shadow: 0 0 10px rgba(16,185,129,0.3);
  }
  .capital-ticks {
    display: flex; justify-content: space-between;
    padding-top: 6px;
  }
  .capital-ticks span {
    font-size: 0.65rem; color: var(--text-secondary);
    font-weight: 600; cursor: pointer; transition: color 0.2s;
  }
  .capital-ticks span:hover { color: var(--text-primary); }

  /* â•â•â•â•â•â•â•â•â•â•â• PERIOD SELECTOR â•â•â•â•â•â•â•â•â•â•â• */
  .period-selector {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px 28px 20px;
    margin-bottom: 28px;
  }
  .period-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 18px;
    flex-wrap: wrap;
    gap: 12px;
  }
  .period-header h3 {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .period-header h3 .p-icon {
    width: 28px; height: 28px; border-radius: 8px;
    display: inline-flex; align-items: center; justify-content: center;
    font-size: 14px;
    background: rgba(99,102,241,0.12);
  }
  .period-summary {
    font-size: 0.82rem;
    color: var(--accent-dax-light);
    font-weight: 600;
    background: rgba(99,102,241,0.08);
    padding: 6px 16px;
    border-radius: 8px;
    border: 1px solid rgba(99,102,241,0.2);
  }
  .period-presets {
    display: flex; gap: 6px; flex-wrap: wrap;
  }
  .preset-btn {
    padding: 5px 14px; border-radius: 8px;
    border: 1px solid var(--border); background: transparent;
    color: var(--text-secondary); font-family: inherit;
    font-size: 0.72rem; font-weight: 600; cursor: pointer;
    transition: all 0.2s; letter-spacing: 0.3px;
  }
  .preset-btn:hover { background: var(--bg-card-hover); color: var(--text-primary); }
  .preset-btn.active {
    background: rgba(99,102,241,0.15);
    border-color: var(--accent-dax);
    color: var(--accent-dax-light);
  }

  /* Timeline track */
  .timeline-wrapper {
    position: relative;
    padding: 0 8px;
  }
  .timeline-track {
    position: relative;
    height: 48px;
    margin: 4px 0 0;
    user-select: none;
  }
  .timeline-bg {
    position: absolute;
    top: 18px; left: 0; right: 0;
    height: 6px;
    background: rgba(30,42,58,0.8);
    border-radius: 3px;
  }
  .timeline-fill {
    position: absolute;
    top: 18px; height: 6px;
    background: linear-gradient(90deg, var(--accent-dax), var(--accent-nas));
    border-radius: 3px;
    transition: left 0.15s, width 0.15s;
    box-shadow: 0 0 12px rgba(99,102,241,0.3);
  }
  .timeline-handle {
    position: absolute;
    top: 10px;
    width: 22px; height: 22px;
    border-radius: 50%;
    background: var(--bg-primary);
    border: 3px solid var(--accent-dax-light);
    cursor: grab;
    z-index: 10;
    transition: transform 0.12s, box-shadow 0.12s;
    transform: translateX(-50%);
  }
  .timeline-handle:hover, .timeline-handle.dragging {
    transform: translateX(-50%) scale(1.2);
    box-shadow: 0 0 16px rgba(99,102,241,0.5);
  }
  .timeline-handle.end {
    border-color: var(--accent-nas-light);
  }
  .timeline-handle.end:hover, .timeline-handle.end.dragging {
    box-shadow: 0 0 16px rgba(6,182,212,0.5);
  }
  .timeline-labels {
    display: flex;
    justify-content: space-between;
    padding-top: 4px;
  }
  .timeline-labels span {
    font-size: 0.62rem;
    color: var(--text-secondary);
    min-width: 32px;
    text-align: center;
    opacity: 0.6;
  }
  .timeline-labels span.year-mark {
    font-weight: 700;
    opacity: 1;
    color: var(--text-primary);
    font-size: 0.68rem;
  }
  .timeline-tooltip {
    position: absolute;
    top: -28px;
    transform: translateX(-50%);
    background: var(--bg-card);
    border: 1px solid var(--border);
    padding: 3px 10px;
    border-radius: 6px;
    font-size: 0.72rem;
    font-weight: 600;
    color: var(--text-primary);
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.15s;
    z-index: 20;
  }
  .timeline-handle:hover .timeline-tooltip,
  .timeline-handle.dragging .timeline-tooltip {
    opacity: 1;
  }

  /* KPI Cards */
  .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 40px; }
  .kpi-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 16px; padding: 24px; position: relative;
    overflow: hidden; transition: transform 0.2s, box-shadow 0.2s;
    animation: holoBorder 8s ease infinite, holoGlow 6s ease infinite;
  }
  .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0,0,0,0.3); }
  .kpi-card .label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--text-secondary); margin-bottom: 8px; }
  .kpi-card .value { font-size: 1.8rem; font-weight: 800; letter-spacing: -0.5px; }
  .kpi-card .sub { font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px; }
  .kpi-card .stripe { position: absolute; top: 0; left: 0; right: 0; height: 3px; }
  .stripe-dax { background: var(--gradient-dax); }
  .stripe-nas { background: var(--gradient-nas); }
  .stripe-merged { background: var(--gradient-merged); }
  .stripe-green { background: linear-gradient(90deg, #10b981, #34d399); }

  /* â•â•â•â•â•â•â•â•â•â•â• HERO KPI â€” Capital Total â•â•â•â•â•â•â•â•â•â•â• */
  .hero-kpi {
    display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px;
    margin-bottom:24px;
  }
  .hero-kpi { animation: slideUp 0.5s ease backwards; }
  .hero-card {
    animation: holoBorder 6s ease infinite, holoGlow 4s ease infinite;
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:16px; padding:28px; position:relative; overflow:hidden;
    transition:transform 0.2s, box-shadow 0.2s;
  }
  .hero-card:hover { transform:translateY(-2px); box-shadow:0 8px 30px rgba(0,0,0,0.3); }
  .hero-card.capital {
    background: linear-gradient(135deg, rgba(16,185,129,0.08), rgba(6,182,212,0.06), rgba(99,102,241,0.06));
    background-size: 200% 200%;
    animation: holoBorder 6s ease infinite, holoGlow 4s ease infinite, holoShift 8s ease infinite;
    border-color:rgba(16,185,129,0.3);
  }
  .hero-card.capital::before {
    content:''; position:absolute; top:0; left:0; right:0; height:3px;
    background:linear-gradient(90deg, #10b981, #06b6d4, #6366f1, #a78bfa, #10b981);
    background-size:300% 100%;
    animation:holoShift 4s linear infinite;
  }
  .hero-card .hero-label { font-size:0.72rem; font-weight:600; text-transform:uppercase; letter-spacing:1.2px; color:var(--text-secondary); margin-bottom:10px; }
  .hero-card .hero-value { font-size:2.2rem; font-weight:800; letter-spacing:-1px; line-height:1.1; }
  .hero-card .hero-sub { font-size:0.78rem; color:var(--text-secondary); margin-top:8px; }
  .hero-card .hero-badge {
    display:inline-block; padding:4px 12px; border-radius:20px; font-size:0.72rem; font-weight:700; margin-top:8px;
  }
  .hero-badge.pos { background:rgba(16,185,129,0.12); color:#10b981; }
  .hero-badge.neg { background:rgba(239,68,68,0.12); color:#ef4444; }

  /* Win rate donut */
  .donut-wrap { display:flex; align-items:center; gap:20px; margin-top:8px; }
  .donut-svg { width:100px; height:100px; transform:rotate(-90deg); }
  .donut-bg { fill:none; stroke:rgba(30,42,58,0.8); stroke-width:7; }
  .donut-fill { fill:none; stroke-width:7; stroke-linecap:round; transition:stroke-dashoffset 0.8s ease; }
  .donut-center { font-size:0.85rem; font-weight:800; fill:var(--text-primary); text-anchor:middle; dominant-baseline:central; }
  .donut-stats { display:flex; flex-direction:column; gap:4px; }
  .donut-stat { font-size:0.78rem; display:flex; align-items:center; gap:6px; }
  .donut-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }

  /* Progress bar KPI */
  .kpi-progress { margin-top:10px; }
  .kpi-bar-bg { height:6px; background:rgba(30,42,58,0.8); border-radius:3px; overflow:hidden; }
  .kpi-bar-fill { height:100%; border-radius:3px; transition:width 0.6s ease; }
  .kpi-bar-labels { display:flex; justify-content:space-between; margin-top:4px; font-size:0.68rem; color:var(--text-secondary); }

  /* RÃ©partition row */
  .repart-row { display:flex; gap:12px; margin-top:12px; }
  .repart-item { flex:1; text-align:center; padding:8px; border-radius:10px; background:rgba(30,42,58,0.3); }
  .repart-item .repart-num { font-size:1.3rem; font-weight:800; }
  .repart-item .repart-label { font-size:0.62rem; font-weight:600; text-transform:uppercase; color:var(--text-secondary); letter-spacing:0.5px; margin-top:2px; }

  @media (max-width: 900px) { .hero-kpi { grid-template-columns:1fr; } }

  .badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; letter-spacing: 0.5px; }
  .badge-dax { background: rgba(99,102,241,0.15); color: var(--accent-dax-light); }
  .badge-nas { background: rgba(6,182,212,0.15); color: var(--accent-nas-light); }

  /* Chart containers */
  .chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
  .chart-full { margin-bottom: 24px; }
  .chart-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 16px; padding: 28px; transition: box-shadow 0.2s;
    animation: holoBorder 10s ease infinite, holoGlow 7s ease infinite;
  }
  .chart-card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
  .chart-card h3 {
    font-size: 1rem; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);
    display: flex; align-items: center; gap: 8px;
  }
  .chart-card h3 .icon {
    width: 28px; height: 28px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center; font-size: 14px;
  }
  .icon-dax { background: rgba(99,102,241,0.15); }
  .icon-nas { background: rgba(6,182,212,0.15); }
  .icon-merged { background: rgba(139,92,246,0.15); }
  .icon-heat { background: rgba(251,146,60,0.15); }
  canvas { max-height: 380px; }

  /* Heatmap */
  .heatmap-container { overflow-x: auto; }
  .heatmap-table { width: 100%; border-collapse: separate; border-spacing: 4px; font-size: 0.78rem; }
  .heatmap-table th { padding: 10px 8px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; font-size: 0.68rem; letter-spacing: 0.8px; }
  .heatmap-table td { padding: 10px 6px; text-align: center; border-radius: 8px; font-weight: 600; font-variant-numeric: tabular-nums; transition: transform 0.15s; }
  .heatmap-table td:hover { transform: scale(1.08); }
  .heatmap-table .year-cell { font-weight: 700; color: var(--text-primary); text-align: left; background: transparent !important; }
  .heatmap-table .total-cell { font-weight: 700; border: 1px solid var(--border); }

  .footer {
    text-align: center; padding: 32px 0 16px; color: var(--text-secondary);
    font-size: 0.75rem; border-top: 1px solid var(--border); margin-top: 40px;
  }

  /* â•â•â•â•â•â•â•â•â•â•â• REAL TRADING TAB â•â•â•â•â•â•â•â•â•â•â• */
  .asset-filter { display:flex; gap:8px; }
  .filter-btn {
    padding:10px 24px; border-radius:10px; border:1px solid var(--border);
    background:var(--bg-card); color:var(--text-secondary); font-family:inherit;
    font-size:0.82rem; font-weight:600; cursor:pointer; transition:all 0.2s;
  }
  .filter-btn:hover { background:var(--bg-card-hover); color:var(--text-primary); }
  .filter-btn.active { background:rgba(16,185,129,0.12); border-color:var(--positive); color:var(--positive); }

  .cal-nav { display:flex; align-items:center; gap:16px; margin-bottom:16px; }
  .cal-nav button {
    width:36px; height:36px; border-radius:10px; border:1px solid var(--border);
    background:var(--bg-card); color:var(--text-primary); font-size:1.1rem;
    cursor:pointer; transition:all 0.2s; display:flex; align-items:center; justify-content:center;
    font-family:inherit;
  }
  .cal-nav button:hover { background:var(--bg-card-hover); }
  .cal-nav .cal-title { font-size:1rem; font-weight:700; min-width:180px; text-align:center; }

  .day-grid { display:grid; grid-template-columns:repeat(5,1fr); gap:4px; }
  .day-header { text-align:center; font-size:0.68rem; font-weight:700; color:var(--text-secondary); padding:8px 0; text-transform:uppercase; }
  .day-cell {
    border-radius:10px; display:flex; flex-direction:column;
    align-items:center; justify-content:center; font-size:0.72rem; font-weight:600;
    transition:transform 0.15s; position:relative; min-height:64px; padding:6px 2px;
  }
  .day-cell:hover { transform:scale(1.05); }
  .day-cell .day-num { font-size:0.65rem; color:var(--text-secondary); margin-bottom:2px; }
  .day-cell .day-pnl { font-size:0.82rem; font-weight:700; }
  .day-cell .day-trades { font-size:0.58rem; color:var(--text-secondary); margin-top:1px; }
  .day-cell.win { background:rgba(16,185,129,0.12); }
  .day-cell.win .day-pnl { color:var(--positive); text-shadow: 0 0 8px rgba(16,185,129,0.3); }
  .day-cell.loss { background:rgba(239,68,68,0.1); }
  .day-cell.loss .day-pnl { color:var(--negative); text-shadow: 0 0 8px rgba(239,68,68,0.3); }
  .day-cell.win .day-num, .day-cell.loss .day-num { color:var(--text-primary); }
  /* Gradient intensities are set via inline style from JS */
  .day-cell.empty { background:transparent; min-height:64px; }
  .day-cell.no-trade { background:rgba(30,42,58,0.08); }
  .day-cell.today { border:2px solid var(--accent-dax-light); }

  .stats-bar {
    display:flex; gap:24px; flex-wrap:wrap; padding:16px 0;
    border-top:1px solid var(--border); margin-top:16px;
  }
  .stat-item { display:flex; align-items:center; gap:6px; font-size:0.8rem; }
  .stat-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
  .stat-dot.green { background:var(--positive); }
  .stat-dot.red { background:var(--negative); }

  .csv-btn {
    padding:8px 20px; border-radius:10px; border:1px solid var(--border);
    background:var(--bg-card); color:var(--text-secondary); font-family:inherit;
    font-size:0.78rem; font-weight:600; cursor:pointer; transition:all 0.2s;
  }
  .csv-btn:hover { background:var(--bg-card-hover); color:var(--text-primary); }
  .capital-mgmt-btn {
    position:absolute; top:12px; right:12px; background:rgba(16,185,129,0.15); border:1px solid rgba(16,185,129,0.3);
    color:var(--positive); border-radius:8px; padding:5px 10px; font-size:0.72rem; font-weight:600;
    cursor:pointer; font-family:inherit; transition:all 0.2s;
  }
  .capital-mgmt-btn:hover { background:rgba(16,185,129,0.25); }
  .cap-form-group { margin-bottom:16px; }
  .cap-form-group label { display:block; font-size:0.78rem; color:var(--text-secondary); margin-bottom:6px; font-weight:500; }
  .cap-form-group input, .cap-form-group select {
    width:100%; padding:10px 12px; background:var(--bg-primary); color:var(--text-primary);
    border:1px solid var(--border); border-radius:8px; font-family:inherit; font-size:0.85rem;
  }
  .cap-form-group input:focus, .cap-form-group select:focus { outline:none; border-color:var(--accent-nas); }
  .cap-form-row { display:flex; gap:12px; }
  .cap-form-row .cap-form-group { flex:1; }
  .cap-history { margin-top:20px; border-top:1px solid var(--border); padding-top:16px; }
  .cap-history h4 { font-size:0.82rem; color:var(--text-secondary); margin-bottom:10px; }
  .cap-history-list { max-height:200px; overflow-y:auto; }
  .cap-history-item {
    display:flex; justify-content:space-between; align-items:center; padding:8px 10px;
    border-radius:8px; margin-bottom:4px; font-size:0.78rem;
  }
  .cap-history-item:nth-child(odd) { background:rgba(30,42,58,0.3); }
  .cap-history-item .cap-h-amount { font-weight:700; }
  .cap-history-item .cap-h-del {
    background:none; border:none; color:var(--text-secondary); cursor:pointer; font-size:0.9rem; padding:2px 6px; border-radius:4px;
  }
  .cap-history-item .cap-h-del:hover { color:var(--negative); background:rgba(239,68,68,0.1); }
  .csv-modal {
    display:none; position:fixed; top:0; left:0; right:0; bottom:0;
    background:rgba(0,0,0,0.7); z-index:1000; align-items:center; justify-content:center;
  }
  .csv-modal.show { display:flex; }
  .csv-modal-content {
    background:var(--bg-card); border:1px solid var(--border); border-radius:16px;
    padding:28px; width:90%; max-width:700px; max-height:80vh; overflow:auto;
  }
  .csv-modal-content h3 { margin-bottom:12px; font-size:1rem; }
  .csv-modal-content p { font-size:0.78rem; color:var(--text-secondary); margin-bottom:12px; }
  .file-drop-zone {
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    width:100%; min-height:180px; background:var(--bg-primary); border:2px dashed var(--border);
    border-radius:12px; cursor:pointer; transition:all 0.3s ease; padding:32px;
  }
  .file-drop-zone:hover, .file-drop-zone.dragover {
    border-color:var(--accent-nas); background:rgba(6,182,212,0.05);
  }
  .file-drop-icon { font-size:2.5rem; margin-bottom:12px; }
  .file-drop-text { font-size:0.88rem; color:var(--text-primary); font-weight:500; }
  .file-drop-hint { font-size:0.72rem; color:var(--text-secondary); margin-top:6px; }
  .file-drop-selected {
    margin-top:14px; padding:8px 16px; background:rgba(16,185,129,0.1);
    border:1px solid rgba(16,185,129,0.3); border-radius:8px;
    color:var(--positive); font-size:0.82rem; font-weight:500;
  }
  .btn-primary:disabled { opacity:0.4; cursor:not-allowed; }
  .csv-modal-actions { display:flex; gap:10px; margin-top:16px; justify-content:flex-end; }
  .btn-primary {
    padding:10px 24px; border-radius:10px; border:none;
    background:linear-gradient(135deg, var(--accent-dax), var(--accent-nas));
    color:white; font-family:inherit; font-size:0.82rem; font-weight:600; cursor:pointer;
  }
  .btn-primary:hover { opacity:0.9; }
  .btn-cancel {
    padding:10px 24px; border-radius:10px; border:1px solid var(--border);
    background:transparent; color:var(--text-secondary); font-family:inherit;
    font-size:0.82rem; font-weight:600; cursor:pointer;
  }
  .btn-cancel:hover { color:var(--text-primary); }
  .real-header-row {
    display:flex; align-items:center; justify-content:space-between;
    flex-wrap:wrap; gap:12px; margin-bottom:20px;
  }

  /* â•â•â•â•â•â•â•â•â•â•â• iOS-style Toggle Switch â•â•â•â•â•â•â•â•â•â•â• */
  .toggle-wrap {
    display:flex; align-items:center; gap:10px; cursor:pointer;
    font-size:0.78rem; font-weight:500; color:var(--text-secondary);
    user-select:none;
  }
  .toggle-wrap:hover { color:var(--text-primary); }
  .toggle-wrap input { display:none; }
  .toggle-track {
    position:relative; width:44px; height:24px;
    background:rgba(30,42,58,0.9); border-radius:12px;
    transition:background 0.3s ease; flex-shrink:0;
    border:1px solid rgba(255,255,255,0.06);
  }
  .toggle-track::after {
    content:''; position:absolute;
    top:2px; left:2px; width:20px; height:20px;
    background:#fff; border-radius:50%;
    transition:transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    box-shadow:0 1px 3px rgba(0,0,0,0.3);
  }
  .toggle-wrap input:checked + .toggle-track {
    background:linear-gradient(135deg, var(--accent-dax), var(--accent-nas));
    border-color:transparent;
  }
  .toggle-wrap input:checked + .toggle-track::after {
    transform:translateX(20px);
  }
  .toggle-label { letter-spacing:0.2px; }
  .toggle-val { font-size:0.72rem; font-weight:700; color:var(--accent-dax-light); min-width:16px; text-align:center; }

  @media (max-width: 900px) {
    .chart-row { grid-template-columns: 1fr; }
    .kpi-grid { grid-template-columns: repeat(2, 1fr); }
    .dashboard { padding: 20px 16px; }
    .period-header { flex-direction: column; align-items: flex-start; }
  }
</style>
</head>
<body>
<div class="dashboard">

  <div class="header">
    <h1>Trading Performance Dashboard</h1>
    <p>DAX 40 (IntradayGrafV4-3) & NASDAQ 100 (NAS 15 OPR R2.2) â€” Capital initial 5 000 â‚¬ â€” DÃ©c. 2017 â†’ FÃ©v. 2026</p>
  </div>

  <!-- TAB BAR -->
  <div class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('real')">
      ğŸ’¹ Trading RÃ©el
      <span class="tab-sub">Ordres IG rÃ©els</span>
    </button>
    <button class="tab-btn" onclick="switchTab('fixed')">
      ğŸ“Š Taille Fixe
      <span class="tab-sub">Backtest sans rÃ©inv.</span>
    </button>
    <button class="tab-btn" onclick="switchTab('reinvest')">
      ğŸš€ RÃ©investissement
      <span class="tab-sub">Backtest rÃ©investi</span>
    </button>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TAB 0 : REAL TRADING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-real" class="tab-content active">
    <div class="real-header-row">
      <div class="asset-filter">
        <button class="filter-btn active" onclick="setAssetFilter('all')">ğŸ“Š Tout</button>
        <button class="filter-btn" onclick="setAssetFilter('NASDAQ')">ğŸŸ¦ NASDAQ</button>
        <button class="filter-btn" onclick="setAssetFilter('DAX')">ğŸŸª DAX</button>
      </div>
      <button class="csv-btn" onclick="openCsvModal()">ğŸ“‚ Mettre Ã  jour CSV</button>
    </div>
    <div class="hero-kpi" id="heroReal"></div>
    <div class="kpi-grid" id="kpiReal"></div>
    <div class="chart-full"><div class="chart-card">
      <h3><span class="icon icon-merged">ğŸ’¹</span> P&L CumulÃ©</h3>
      <canvas id="pnlCumReal"></canvas>
    </div></div>
    <div class="chart-row">
      <div class="chart-card"><h3><span class="icon icon-dax">ğŸ“Š</span> Gain Moyen</h3><canvas id="avgGainReal"></canvas></div>
      <div class="chart-card"><h3 style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;"><span><span class="icon icon-nas">ğŸ“Š</span> Gagnants vs Perdants par Jour</span><label class="toggle-wrap"><input type="checkbox" id="winLossPctToggle" onchange="rebuildWinLossDay()"><span class="toggle-track"></span><span class="toggle-val toggle-label">Nombre</span><span class="toggle-val">Montant â‚¬</span></label></h3><canvas id="winLossDayReal"></canvas></div>
    </div>
    <div class="chart-full"><div class="chart-card">
      <h3 style="justify-content:space-between;flex-wrap:wrap;">
        <span style="display:flex;align-items:center;gap:8px;"><span class="icon icon-heat">ğŸ“…</span> Calendrier Journalier</span>
        <label class="toggle-wrap">
          <span class="toggle-val">â‚¬</span>
          <input type="checkbox" id="dayPctToggle" onchange="buildDailyCalendar(); this.parentElement.querySelector('.toggle-val').textContent=this.checked?'%':'â‚¬'">
          <span class="toggle-track"></span>
          <span class="toggle-val">%</span>
        </label>
      </h3>
      <div class="cal-nav">
        <button onclick="calPrev()">â—€</button>
        <span class="cal-title" id="calTitle">FÃ©vrier 2026</span>
        <button onclick="calNext()">â–¶</button>
      </div>
      <div class="day-grid" id="dayGrid"></div>
      <div class="stats-bar" id="dayStats"></div>
    </div></div>
    <div class="chart-full"><div class="chart-card">
      <h3 style="justify-content:space-between;flex-wrap:wrap;">
        <span style="display:flex;align-items:center;gap:8px;"><span class="icon icon-heat">ğŸ“Š</span> Performance Mensuelle</span>
        <label class="toggle-wrap">
          <span class="toggle-val">â‚¬</span>
          <input type="checkbox" id="monthPctToggle" onchange="buildMonthlyHeatReal(); this.parentElement.querySelector('.toggle-val').textContent=this.checked?'%':'â‚¬'">
          <span class="toggle-track"></span>
          <span class="toggle-val">%</span>
        </label>
      </h3>
      <div class="heatmap-container" id="monthlyHeatReal"></div>
      <div class="stats-bar" id="monthStats"></div>
    </div></div>
    <div class="chart-full"><div class="chart-card">
      <h3><span class="icon icon-heat">ğŸ“‰</span> Drawdown depuis le Plus Haut</h3>
      <canvas id="drawdownReal"></canvas>
    </div></div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" style="display:flex; position:fixed; inset:0; z-index:9999; background:rgba(10,14,26,0.92); justify-content:center; align-items:center; flex-direction:column; gap:20px;">
    <div style="width:48px;height:48px;border:3px solid var(--border);border-top-color:var(--accent-nas);border-radius:50%;animation:spin 0.8s linear infinite;"></div>
    <div style="color:var(--text-secondary);font-size:14px;font-family:Inter,sans-serif;">Chargement des donnÃ©es depuis Firebase...</div>
  </div>
  <style>#loadingOverlay { backdrop-filter:blur(4px); } @keyframes spin { to { transform:rotate(360deg); } }</style>

  <!-- CSV Modal -->
  <div class="csv-modal" id="csvModal">
    <div class="csv-modal-content">
      <h3>ğŸ“‚ Mettre Ã  jour les donnÃ©es</h3>
      <p>SÃ©lectionnez votre fichier CSV exportÃ© depuis IG (sÃ©parateur tabulation).</p>
      <label class="file-drop-zone" id="fileDropZone">
        <input type="file" id="csvFileInput" accept=".csv,.txt,.tsv" style="display:none" onchange="handleFileSelect(this)">
        <div class="file-drop-icon">ğŸ“„</div>
        <div class="file-drop-text">Cliquez ou glissez votre fichier ici</div>
        <div class="file-drop-hint">.csv, .txt, .tsv â€” export IG</div>
        <div class="file-drop-selected" id="fileSelectedName" style="display:none"></div>
      </label>
      <div class="csv-modal-actions">
        <button class="btn-cancel" onclick="closeCsvModal()">Annuler</button>
        <button class="btn-primary" id="btnApplyCsv" onclick="applyCsv()" disabled>âœ… Appliquer</button>
      </div>
    </div>
  </div>

  <!-- Capital Management Modal -->
  <div class="csv-modal" id="capitalModal">
    <div class="csv-modal-content" style="max-width:500px;">
      <h3>ğŸ’° GÃ©rer le capital</h3>
      <p>Ajoutez un dÃ©pÃ´t ou un retrait pour ajuster votre capital total.</p>
      <div class="cap-form-row">
        <div class="cap-form-group">
          <label>Type</label>
          <select id="capType">
            <option value="deposit">â• DÃ©pÃ´t</option>
            <option value="withdrawal">â– Retrait</option>
          </select>
        </div>
        <div class="cap-form-group">
          <label>Montant (â‚¬)</label>
          <input type="number" id="capAmount" placeholder="1000" min="0" step="0.01">
        </div>
      </div>
      <div class="cap-form-group">
        <label>Date</label>
        <input type="date" id="capDate">
      </div>
      <div class="csv-modal-actions">
        <button class="btn-cancel" onclick="closeCapitalModal()">Annuler</button>
        <button class="btn-primary" onclick="addCapitalAdjustment()">âœ… Valider</button>
      </div>
      <div class="cap-history">
        <h4>Historique des mouvements</h4>
        <div class="cap-history-list" id="capHistoryList"></div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TAB 1 : FIXED â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-fixed" class="tab-content">
    <!-- Capital Selector -->
    <div class="capital-selector" id="capitalFixed">
      <div class="capital-header">
        <h3><span class="c-icon">ğŸ’°</span> Capital initial total</h3>
        <div class="capital-value-display">
          <span class="capital-amount" id="capAmountFixed">10 000 â‚¬</span>
          <span class="capital-detail" id="capDetailFixed">â†’ 5 000 â‚¬ par stratÃ©gie</span>
        </div>
      </div>
      <div class="capital-slider-wrap">
        <input type="range" class="capital-slider" id="capSliderFixed" min="10000" max="100000" step="5000" value="10000">
        <div class="capital-ticks" id="capTicksFixed"></div>
      </div>
    </div>
    <!-- Period Selector -->
    <div class="period-selector" id="periodFixed">
      <div class="period-header">
        <h3><span class="p-icon">ğŸ“…</span> PÃ©riode d'analyse</h3>
        <span class="period-summary" id="summaryFixed">DÃ©c 2017 â†’ FÃ©v 2026</span>
        <div class="period-presets" id="presetsFixed"></div>
      </div>
      <div class="timeline-wrapper">
        <div class="timeline-track" id="trackFixed">
          <div class="timeline-bg"></div>
          <div class="timeline-fill" id="fillFixed"></div>
          <div class="timeline-handle start" id="handleStartFixed">
            <div class="timeline-tooltip" id="tipStartFixed">DÃ©c 2017</div>
          </div>
          <div class="timeline-handle end" id="handleEndFixed">
            <div class="timeline-tooltip" id="tipEndFixed">FÃ©v 2026</div>
          </div>
        </div>
        <div class="timeline-labels" id="labelsFixed"></div>
      </div>
    </div>
    <div class="kpi-grid" id="kpiFixed"></div>
    <div class="chart-full"><div class="chart-card">
      <h3><span class="icon icon-merged">ğŸ“ˆ</span> Courbe de Capital â€” Taille Fixe</h3>
      <canvas id="eqFixed"></canvas>
    </div></div>
    <div class="chart-full"><div class="chart-card">
      <h3><span class="icon icon-merged">ğŸ“Š</span> Performance Annuelle ComparÃ©e</h3>
      <canvas id="annFixed"></canvas>
    </div></div>
    <div class="chart-row">
      <div class="chart-card"><h3><span class="icon icon-dax">ğŸ“‰</span> Mensuel â€” DAX 40</h3><canvas id="mDaxFixed"></canvas></div>
      <div class="chart-card"><h3><span class="icon icon-nas">ğŸ“‰</span> Mensuel â€” NASDAQ 100</h3><canvas id="mNasFixed"></canvas></div>
    </div>
    <div class="chart-row">
      <div class="chart-card"><h3><span class="icon icon-merged">âš¡</span> Mensuel CombinÃ© (moyenne)</h3><canvas id="mCombFixed"></canvas></div>
      <div class="chart-card"><h3><span class="icon icon-merged">ğŸ”„</span> Glissant 12 mois</h3><canvas id="r12Fixed"></canvas></div>
    </div>
    <div class="chart-full"><div class="chart-card">
      <h3><span class="icon icon-dax">ğŸŸª</span> Heatmap â€” DAX 40 <span class="badge badge-dax">IntradayGrafV4-3</span></h3>
      <div class="heatmap-container" id="hmDaxFixed"></div>
    </div></div>
    <div class="chart-full"><div class="chart-card">
      <h3><span class="icon icon-nas">ğŸŸ¦</span> Heatmap â€” NASDAQ 100 <span class="badge badge-nas">NAS 15 OPR R2.2</span></h3>
      <div class="heatmap-container" id="hmNasFixed"></div>
    </div></div>
    <div class="chart-full"><div class="chart-card">
      <h3><span class="icon icon-merged">ğŸŸ£</span> Heatmap CombinÃ©e</h3>
      <div class="heatmap-container" id="hmMergedFixed"></div>
    </div></div>
    <div class="chart-full"><div class="chart-card">
      <h3><span class="icon icon-heat">ğŸ”»</span> Drawdown depuis le plus haut</h3>
      <canvas id="ddFixed"></canvas>
    </div></div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TAB 2 : REINVEST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="tab-reinvest" class="tab-content">
    <!-- Capital Selector -->
    <div class="capital-selector" id="capitalReinvest">
      <div class="capital-header">
        <h3><span class="c-icon">ğŸ’°</span> Capital initial total</h3>
        <div class="capital-value-display">
          <span class="capital-amount" id="capAmountReinvest">10 000 â‚¬</span>
          <span class="capital-detail" id="capDetailReinvest">â†’ 5 000 â‚¬ par stratÃ©gie</span>
        </div>
      </div>
      <div class="capital-slider-wrap">
        <input type="range" class="capital-slider" id="capSliderReinvest" min="10000" max="100000" step="5000" value="10000">
        <div class="capital-ticks" id="capTicksReinvest"></div>
      </div>
    </div>
    <!-- Period Selector -->
    <div class="period-selector" id="periodReinvest">
      <div class="period-header">
        <h3><span class="p-icon">ğŸ“…</span> PÃ©riode d'analyse</h3>
        <span class="period-summary" id="summaryReinvest">DÃ©c 2017 â†’ FÃ©v 2026</span>
        <div class="period-presets" id="presetsReinvest"></div>
      </div>
      <div class="timeline-wrapper">
        <div class="timeline-track" id="trackReinvest">
          <div class="timeline-bg"></div>
          <div class="timeline-fill" id="fillReinvest"></div>
          <div class="timeline-handle start" id="handleStartReinvest">
            <div class="timeline-tooltip" id="tipStartReinvest">DÃ©c 2017</div>
          </div>
          <div class="timeline-handle end" id="handleEndReinvest">
            <div class="timeline-tooltip" id="tipEndReinvest">FÃ©v 2026</div>
          </div>
        </div>
        <div class="timeline-labels" id="labelsReinvest"></div>
      </div>
    </div>
    <div class="kpi-grid" id="kpiReinvest"></div>
    <div class="chart-full"><div class="chart-card">
      <h3><span class="icon icon-merged">ğŸš€</span> Courbe de Capital â€” RÃ©investissement</h3>
      <canvas id="eqReinvest"></canvas>
    </div></div>
    <div class="chart-full"><div class="chart-card">
      <h3><span class="icon icon-merged">ğŸ“Š</span> Performance Annuelle ComparÃ©e</h3>
      <canvas id="annReinvest"></canvas>
    </div></div>
    <div class="chart-row">
      <div class="chart-card"><h3><span class="icon icon-dax">ğŸ“‰</span> Mensuel â€” DAX 40</h3><canvas id="mDaxReinvest"></canvas></div>
      <div class="chart-card"><h3><span class="icon icon-nas">ğŸ“‰</span> Mensuel â€” NASDAQ 100</h3><canvas id="mNasReinvest"></canvas></div>
    </div>
    <div class="chart-row">
      <div class="chart-card"><h3><span class="icon icon-merged">âš¡</span> Mensuel CombinÃ© (moyenne)</h3><canvas id="mCombReinvest"></canvas></div>
      <div class="chart-card"><h3><span class="icon icon-merged">ğŸ”„</span> Glissant 12 mois</h3><canvas id="r12Reinvest"></canvas></div>
    </div>
    <div class="chart-full"><div class="chart-card">
      <h3><span class="icon icon-dax">ğŸŸª</span> Heatmap â€” DAX 40 <span class="badge badge-dax">IntradayGrafV4-3</span></h3>
      <div class="heatmap-container" id="hmDaxReinvest"></div>
    </div></div>
    <div class="chart-full"><div class="chart-card">
      <h3><span class="icon icon-nas">ğŸŸ¦</span> Heatmap â€” NASDAQ 100 <span class="badge badge-nas">NAS 15 OPR R2.2</span></h3>
      <div class="heatmap-container" id="hmNasReinvest"></div>
    </div></div>
    <div class="chart-full"><div class="chart-card">
      <h3><span class="icon icon-merged">ğŸŸ£</span> Heatmap CombinÃ©e</h3>
      <div class="heatmap-container" id="hmMergedReinvest"></div>
    </div></div>
    <div class="chart-full"><div class="chart-card">
      <h3><span class="icon icon-heat">ğŸ”»</span> Drawdown depuis le plus haut</h3>
      <canvas id="ddReinvest"></canvas>
    </div></div>
  </div>

  <div class="footer">
    Dashboard gÃ©nÃ©rÃ© le 19 fÃ©vrier 2026 â€” Capital de dÃ©part : 5 000 â‚¬ par stratÃ©gie â€” DonnÃ©es ProBacktest
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const monthNames = ['Jan','FÃ©v','Mar','Avr','Mai','Jun','Jul','AoÃ»','Sep','Oct','Nov','DÃ©c'];
const monthNamesFull = ['Janvier','FÃ©vrier','Mars','Avril','Mai','Juin','Juillet','AoÃ»t','Septembre','Octobre','Novembre','DÃ©cembre'];

// Full timeline of all active months
const ALL_MONTHS = [];
// Dec 2017
ALL_MONTHS.push({ y: 2017, m: 11 });
// 2018-2025 full
for (let y = 2018; y <= 2025; y++) for (let m = 0; m < 12; m++) ALL_MONTHS.push({ y, m });
// Jan-Feb 2026
ALL_MONTHS.push({ y: 2026, m: 0 });
ALL_MONTHS.push({ y: 2026, m: 1 });

function mLabel(ym) { return monthNames[ym.m] + ' ' + ym.y; }
function mLabelFull(ym) { return monthNamesFull[ym.m] + ' ' + ym.y; }

// â”€â”€ FIXED (sans rÃ©inv) â”€â”€
const fDax = {
  2017:[0,0,0,0,0,0,0,0,0,0,0,6.31],
  2018:[5.67,21.21,9.31,0.41,1.65,-0.90,12.06,2.02,3.34,6.03,2.74,3.81],
  2019:[-4.22,1.90,5.97,3.79,0.17,0.31,-0.08,5.76,-1.83,6.53,5.53,2.13],
  2020:[6.06,2.08,1.92,-0.02,-0.58,1.39,-1.13,1.75,4.71,10.34,7.91,-0.25],
  2021:[-2.65,2.69,2.11,-0.02,7.42,3.37,0.64,1.99,0.54,-2.18,0.77,4.63],
  2022:[2.07,-0.91,2.54,1.62,3.35,2.31,-2.03,3.97,2.42,-0.57,2.92,0.88],
  2023:[1.33,-1.58,1.01,0.85,7.32,1.59,0.03,0.70,0.50,-1.65,0.67,0.02],
  2024:[1.04,2.90,1.12,1.24,2.23,1.63,4.67,3.74,0.89,1.58,1.15,0.40],
  2025:[-0.00,1.08,1.32,-1.57,-0.34,0.79,-0.27,-2.00,-0.04,1.63,0.77,-0.01],
  2026:[-1.32,0.60,0,0,0,0,0,0,0,0,0,0]
};
const fNas = {
  2017:[0,0,0,0,0,0,0,0,0,0,0,1.08],
  2018:[-2.41,8.58,-7.21,14.16,1.62,3.60,9.93,2.12,6.38,6.31,-3.18,5.74],
  2019:[2.23,0.95,1.81,-2.00,-4.17,2.30,0.93,0.56,-0.34,1.12,-3.06,0.53],
  2020:[5.46,5.00,-3.52,-3.52,-6.57,4.89,-3.57,3.83,12.49,-0.15,-2.41,-0.42],
  2021:[-5.61,-6.08,-6.39,8.56,12.45,2.20,6.16,0.01,-4.51,9.18,0.39,3.09],
  2022:[-2.16,4.93,-2.46,16.08,9.02,-5.22,-0.55,4.93,-2.23,0.79,3.41,1.05],
  2023:[8.48,2.31,-0.28,-3.48,1.02,2.34,-2.70,7.68,-2.75,5.48,1.77,-1.44],
  2024:[1.17,-0.84,-0.19,3.09,2.95,-1.42,7.23,1.89,4.17,5.06,3.31,5.55],
  2025:[-0.18,5.09,-1.30,0.82,0.31,-3.82,0.26,2.71,1.88,2.42,-0.33,3.82],
  2026:[1.90,4.73,0,0,0,0,0,0,0,0,0,0]
};

// â”€â”€ REINVEST â”€â”€
const rDax = {
  2017:[0,0,0,0,0,0,0,0,0,0,0,5.81],
  2018:[5.85,25.47,12.38,0.12,2.26,-1.92,19.07,2.20,5.23,10.63,3.99,6.42],
  2019:[-8.28,2.57,11.63,7.99,-0.15,0.35,-0.62,11.85,-4.33,14.26,13.14,4.41],
  2020:[15.13,5.03,5.41,-0.01,-1.75,3.94,-3.53,5.02,13.39,34.37,26.86,-0.89],
  2021:[-9.69,9.56,7.65,-0.01,29.85,12.71,1.59,8.29,1.24,-8.98,2.67,20.23],
  2022:[8.66,-4.30,11.71,6.64,15.29,11.16,-9.61,19.96,11.93,-2.93,15.09,4.07],
  2023:[6.82,-8.08,4.70,4.17,43.66,8.75,-0.43,3.25,2.58,-10.34,3.53,-0.06],
  2024:[5.84,17.39,6.74,7.36,14.14,10.29,33.22,27.02,6.24,11.42,7.06,2.29],
  2025:[-0.13,7.78,9.82,-11.86,-2.49,5.25,-1.96,-13.77,-0.43,12.02,5.11,-0.00],
  2026:[-9.74,3.89,0,0,0,0,0,0,0,0,0,0]
};
const rNas = {
  2017:[0,0,0,0,0,0,0,0,0,0,0,1.08],
  2018:[-2.50,8.48,-7.64,14.65,1.79,4.17,12.38,2.71,8.88,8.69,-4.99,8.23],
  2019:[3.25,1.49,2.85,-3.27,-6.65,3.42,1.43,0.72,-0.64,1.68,-4.84,0.78],
  2020:[8.74,8.14,-6.15,-6.03,-10.23,7.02,-5.92,5.51,20.82,-0.75,-4.38,-0.89],
  2021:[-9.48,-9.73,-9.71,12.67,20.94,3.55,11.21,-0.24,-8.44,17.45,0.47,5.35],
  2022:[-5.02,9.70,-5.63,37.57,22.25,-13.00,-1.76,11.95,-5.79,1.70,8.35,2.05],
  2023:[24.41,6.52,-1.19,-10.00,2.34,6.27,-7.83,23.51,-8.51,17.07,5.35,-4.61],
  2024:[3.20,-2.85,-1.01,9.02,9.66,-4.86,25.63,5.82,15.66,20.20,13.31,24.45],
  2025:[-1.33,23.34,-5.95,2.82,1.01,-16.11,0.92,11.72,7.98,10.60,-1.71,18.28],
  2026:[9.02,24.78,0,0,0,0,0,0,0,0,0,0]
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE CONFIGURATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig = {
  apiKey: "AIzaSyA2QeMTVgKgHaeyGYXcs-AXpi1rO7GikIo",
  authDomain: "portfolio-dashboard-f0c69.firebaseapp.com",
  databaseURL: "https://portfolio-dashboard-f0c69-default-rtdb.firebaseio.com",
  projectId: "portfolio-dashboard-f0c69",
  storageBucket: "portfolio-dashboard-f0c69.firebasestorage.app",
  messagingSenderId: "444106868590",
  appId: "1:444106868590:web:682fbc10b01ccb7bfbe37f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REAL TRADING DATA â€” chargÃ© depuis Firebase
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let realTrades = [];
let firebaseReady = false;

function showLoading(show) {
  const el = document.getElementById('loadingOverlay');
  if (el) el.style.display = show ? 'flex' : 'none';
}

// Charger les trades depuis Firebase
function loadTradesFromFirebase() {
  showLoading(true);
  return db.ref('trades').once('value').then(snapshot => {
    const data = snapshot.val();
    if (data) {
      // data est un objet { key: {date, symbol, gain}, ... } ou un tableau
      if (Array.isArray(data)) {
        realTrades = data.map(t => [t.date, t.symbol, t.gain]);
      } else {
        realTrades = Object.values(data).map(t => [t.date, t.symbol, t.gain]);
      }
    }
    firebaseReady = true;
    showLoading(false);
    return realTrades;
  }).catch(err => {
    console.error('Erreur Firebase:', err);
    showLoading(false);
    firebaseReady = true;
    // Afficher un message dans le dashboard
    const hero = document.getElementById('heroReal');
    if (hero) hero.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--negative);">âš ï¸ Erreur de connexion Firebase. VÃ©rifiez les rÃ¨gles de votre base de donnÃ©es.</div>';
    return [];
  });
}

// Sauvegarder les trades dans Firebase
function saveTradesToFirebase(trades) {
  const data = trades.map((t, i) => ({
    date: t[0],
    symbol: t[1],
    gain: t[2]
  }));
  return db.ref('trades').set(data).then(() => {
    console.log('âœ… Trades sauvegardÃ©s dans Firebase (' + trades.length + ' trades)');
  }).catch(err => {
    console.error('Erreur sauvegarde Firebase:', err);
    alert('Erreur lors de la sauvegarde dans Firebase: ' + err.message);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAPITAL ADJUSTMENTS (dÃ©pÃ´ts / retraits)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let capitalAdjustments = []; // [{date, type, amount, id}]

function loadCapitalAdjustments() {
  return db.ref('capitalAdjustments').once('value').then(snapshot => {
    const data = snapshot.val();
    if (data) {
      capitalAdjustments = Array.isArray(data) ? data : Object.values(data);
    }
    return capitalAdjustments;
  }).catch(err => {
    console.error('Erreur chargement ajustements:', err);
    return [];
  });
}

function saveCapitalAdjustments() {
  return db.ref('capitalAdjustments').set(capitalAdjustments).catch(err => {
    console.error('Erreur sauvegarde ajustements:', err);
  });
}

function getTotalAdjustments() {
  return capitalAdjustments.reduce((sum, a) => sum + (a.type === 'deposit' ? a.amount : -a.amount), 0);
}

function openCapitalModal() {
  document.getElementById('capitalModal').classList.add('show');
  document.getElementById('capDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('capAmount').value = '';
  document.getElementById('capType').value = 'deposit';
  renderCapHistory();
}

function closeCapitalModal() {
  document.getElementById('capitalModal').classList.remove('show');
}

function addCapitalAdjustment() {
  const type = document.getElementById('capType').value;
  const amount = parseFloat(document.getElementById('capAmount').value);
  const date = document.getElementById('capDate').value;
  if (!amount || amount <= 0 || !date) {
    alert('Veuillez renseigner un montant valide et une date.');
    return;
  }
  capitalAdjustments.push({ date, type, amount, id: Date.now() });
  capitalAdjustments.sort((a,b) => a.date.localeCompare(b.date));
  saveCapitalAdjustments();
  renderCapHistory();
  renderRealTab();
  document.getElementById('capAmount').value = '';
}

function removeCapitalAdjustment(id) {
  capitalAdjustments = capitalAdjustments.filter(a => a.id !== id);
  saveCapitalAdjustments();
  renderCapHistory();
  renderRealTab();
}

function renderCapHistory() {
  const list = document.getElementById('capHistoryList');
  if (!list) return;
  if (capitalAdjustments.length === 0) {
    list.innerHTML = '<div style="color:var(--text-secondary);font-size:0.78rem;padding:8px;">Aucun mouvement enregistrÃ©.</div>';
    return;
  }
  const sorted = [...capitalAdjustments].sort((a,b) => b.date.localeCompare(a.date));
  list.innerHTML = sorted.map(a => {
    const sign = a.type === 'deposit' ? '+' : '-';
    const color = a.type === 'deposit' ? 'var(--positive)' : 'var(--negative)';
    const label = a.type === 'deposit' ? 'DÃ©pÃ´t' : 'Retrait';
    const dateDisplay = new Date(a.date).toLocaleDateString('fr-FR',{day:'numeric',month:'short',year:'numeric'});
    return `<div class="cap-history-item">
      <span>${dateDisplay} â€” <em>${label}</em></span>
      <span><span class="cap-h-amount" style="color:${color}">${sign}${a.amount.toFixed(2)} â‚¬</span>
      <button class="cap-h-del" onclick="removeCapitalAdjustment(${a.id})" title="Supprimer">âœ•</button></span>
    </div>`;
  }).join('');
}

let currentAssetFilter = 'all';
let calYear = 2026, calMonth = 1; // Feb 2026 (0-indexed month)

function getFilteredTrades() {
  if (currentAssetFilter === 'all') return realTrades;
  return realTrades.filter(t => t[1] === currentAssetFilter);
}

function setAssetFilter(f) {
  currentAssetFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => {
    const txt = b.textContent.trim();
    b.classList.toggle('active',
      (f==='all' && txt.includes('Tout')) || txt.includes(f));
  });
  renderRealTab();
}

function aggregateByDay(trades) {
  const m = {};
  for (const [d, s, g] of trades) {
    if (!m[d]) m[d] = { pnl:0, trades:0, wins:0, losses:0 };
    m[d].pnl += g;
    m[d].trades++;
    if (g > 0) m[d].wins++; else m[d].losses++;
  }
  return m;
}

function aggregateByMonth(trades) {
  const m = {};
  for (const [d, s, g] of trades) {
    const key = d.substring(0, 7);
    if (!m[key]) m[key] = { pnl:0, trades:0, wins:0 };
    m[key].pnl += g;
    m[key].trades++;
    if (g > 0) m[key].wins++;
  }
  return m;
}

function buildRealKPIs() {
  const trades = getFilteredTrades();
  const gains = trades.map(t => t[2]);
  const total = gains.reduce((a,b) => a+b, 0);
  const wins = gains.filter(g => g > 0);
  const losses = gains.filter(g => g <= 0);
  const winRateNum = gains.length > 0 ? (wins.length / gains.length * 100) : 0;
  const avgWin = wins.length > 0 ? wins.reduce((a,b)=>a+b,0)/wins.length : 0;
  const avgLoss = losses.length > 0 ? losses.reduce((a,b)=>a+b,0)/losses.length : 0;
  const best = gains.length > 0 ? Math.max(...gains) : 0;
  const worst = gains.length > 0 ? Math.min(...gains) : 0;
  const totalWins = wins.reduce((a,b)=>a+b,0);
  const totalLosses = Math.abs(losses.reduce((a,b)=>a+b,0));
  const pf = totalLosses > 0 ? (totalWins/totalLosses) : Infinity;
  const rr = avgLoss !== 0 ? Math.abs(avgWin / avgLoss) : Infinity;

  // Trades per day (unique trading days)
  const tradingDays = new Set(trades.map(t => t[0])).size;
  const avgTradesPerDay = tradingDays > 0 ? (trades.length / tradingDays) : 0;

  // Max drawdown from cumulative P&L
  const sorted = [...trades].sort((a,b) => a[0].localeCompare(b[0]));
  let cum = 0, peak = 0, maxDD = 0;
  for (const [d, s, g] of sorted) {
    cum += g;
    if (cum > peak) peak = cum;
    const dd = peak - cum;
    if (dd > maxDD) maxDD = dd;
  }

  // Capital â€” toujours basÃ© sur TOUS les trades + ajustements, pas le filtre actif
  const allGains = realTrades.map(t => t[2]);
  const totalAll = allGains.reduce((a,b) => a+b, 0);
  const totalAdjustments = getTotalAdjustments();
  const capitalActuel = REAL_INITIAL_CAPITAL + totalAll + totalAdjustments;
  const capitalBase = REAL_INITIAL_CAPITAL + totalAdjustments;
  const perfPct = capitalBase > 0 ? (totalAll / capitalBase * 100) : 0;

  // Donut SVG for win rate
  const circumference = 2 * Math.PI * 28; // r=28
  const dashOffset = circumference * (1 - winRateNum / 100);
  const donutColor = winRateNum >= 50 ? '#10b981' : '#ef4444';

  // â”€â”€ HERO ROW â”€â”€
  document.getElementById('heroReal').innerHTML = `
    <div class="hero-card capital" style="position:relative;">
      <button class="capital-mgmt-btn" onclick="openCapitalModal()">Â± GÃ©rer</button>
      <div class="hero-label">ğŸ’° Capital Actuel</div>
      <div class="hero-value" style="background:linear-gradient(135deg,${totalAll>=0?'#10b981,#34d399':'#ef4444,#f87171'});-webkit-background-clip:text;-webkit-text-fill-color:transparent;">
        ${fmt(Math.round(capitalActuel))} â‚¬
      </div>
      <div class="hero-sub">Capital initial : ${fmt(REAL_INITIAL_CAPITAL)} â‚¬ Â· Ajustements : ${totalAdjustments>=0?'+':''}${totalAdjustments.toFixed(2)} â‚¬</div>
      <span class="hero-badge ${perfPct>=0?'pos':'neg'}">${perfPct>=0?'+':''}${perfPct.toFixed(2)}%</span>
    </div>
    <div class="hero-card">
      <div class="hero-label">ğŸ“ˆ Gain Total</div>
      <div class="hero-value" style="color:${total>=0?'var(--positive)':'var(--negative)'};">
        ${total>=0?'+':''}${total.toFixed(2)} â‚¬
      </div>
      <div style="display:flex;gap:16px;margin-top:10px;">
        <div><div style="font-size:0.68rem;color:var(--text-secondary);text-transform:uppercase;font-weight:600;">Gain brut</div>
        <div style="color:var(--positive);font-weight:700;font-size:0.9rem;">+${totalWins.toFixed(2)} â‚¬</div></div>
        <div><div style="font-size:0.68rem;color:var(--text-secondary);text-transform:uppercase;font-weight:600;">Perte brute</div>
        <div style="color:var(--negative);font-weight:700;font-size:0.9rem;">-${totalLosses.toFixed(2)} â‚¬</div></div>
      </div>
    </div>
    <div class="hero-card">
      <div class="hero-label">ğŸ¯ Trades Gagnants</div>
      <div class="donut-wrap">
        <svg class="donut-svg" viewBox="0 0 64 64">
          <circle class="donut-bg" cx="32" cy="32" r="28"/>
          <circle class="donut-fill" cx="32" cy="32" r="28"
            stroke="${donutColor}"
            stroke-dasharray="${circumference.toFixed(1)}"
            stroke-dashoffset="${dashOffset.toFixed(1)}"/>
          <text class="donut-center" x="32" y="32" transform="rotate(90 32 32)">${winRateNum.toFixed(1)}%</text>
        </svg>
        <div class="donut-stats">
          <div class="donut-stat"><span class="donut-dot" style="background:var(--positive);"></span><strong>${wins.length}</strong>&nbsp;gagnants</div>
          <div class="donut-stat"><span class="donut-dot" style="background:var(--negative);"></span><strong>${losses.length}</strong>&nbsp;perdants</div>
          <div class="donut-stat" style="color:var(--text-secondary);">${trades.length} trades total</div>
        </div>
      </div>
    </div>
  `;

  // â”€â”€ KPI GRID (smaller cards) â”€â”€
  const pfColor = pf >= 1 ? 'var(--positive)' : 'var(--negative)';
  const rrColor = rr >= 1 ? 'var(--positive)' : 'var(--negative)';
  const kpis = [
    { l:'Profit Factor', v:pf === Infinity ? 'âˆ' : pf.toFixed(2), s:'Gains / Pertes brutes', c:'stripe-merged', vc:pfColor },
    { l:'Risk/Reward', v:rr === Infinity ? 'âˆ' : rr.toFixed(2), s:'Gain moy / Perte moy', c:'stripe-nas', vc:rrColor },
    { l:'Gain Moyen', v:'+'+avgWin.toFixed(2)+' â‚¬', s:'Max : +'+best.toFixed(2)+' â‚¬', c:'stripe-green', vc:'var(--positive)' },
    { l:'Perte Moyenne', v:avgLoss.toFixed(2)+' â‚¬', s:'Max : '+worst.toFixed(2)+' â‚¬', c:'stripe-dax', vc:'var(--negative)' },
    { l:'Drawdown Max', v:'-'+maxDD.toFixed(2)+' â‚¬', s:'-'+(maxDD/REAL_INITIAL_CAPITAL*100).toFixed(2)+'% du capital', c:'stripe-dax', vc:'var(--negative)' },
    { l:'Moy. Trades/Jour', v:avgTradesPerDay.toFixed(1), s:tradingDays+' jours de trading', c:'stripe-merged', vc:'var(--text-primary)' },
  ];
  document.getElementById('kpiReal').innerHTML = kpis.map(k =>
    `<div class="kpi-card"><div class="stripe ${k.c}"></div><div class="label">${k.l}</div><div class="value" style="color:${k.vc}">${k.v}</div><div class="sub">${k.s}</div></div>`
  ).join('');
}

// â”€â”€ Traveling Light Plugin for line charts â”€â”€
function _tlHexToRgb(hex) {
  const h = hex.replace('#','');
  return [parseInt(h.substring(0,2),16), parseInt(h.substring(2,4),16), parseInt(h.substring(4,6),16)];
}
const travelingLightPlugin = {
  id: 'travelingLight',
  afterDatasetsDraw(chart) {
    const ctx = chart.ctx;
    const now = Date.now();
    // Timing: 2s fast sweep + 3s pause = 5s total cycle
    const sweepMs = 2000;
    const pauseMs = 3000;
    const cycleMs = sweepMs + pauseMs;

    chart.data.datasets.forEach((ds, dsIdx) => {
      if (chart.config.type !== 'line') return;
      const meta = chart.getDatasetMeta(dsIdx);
      if (!meta.visible || meta.data.length < 2) return;

      const phase = (now + dsIdx * 1800) % cycleMs;
      let t; // 0..1 position along curve
      if (phase < sweepMs) {
        // Fast sweep with ease-in-out
        const linear = phase / sweepMs;
        t = linear < 0.5
          ? 2 * linear * linear
          : 1 - Math.pow(-2 * linear + 2, 2) / 2;
      } else {
        t = 1; // Paused at end
      }

      const totalPts = meta.data.length;
      const exactIdx = t * (totalPts - 1);
      const i0 = Math.floor(exactIdx);
      const i1 = Math.min(i0 + 1, totalPts - 1);
      const frac = exactIdx - i0;
      const p0 = meta.data[i0];
      const p1 = meta.data[i1];
      const x = p0.x + (p1.x - p0.x) * frac;
      const y = p0.y + (p1.y - p0.y) * frac;
      const rawColor = ds.borderColor || '#6366f1';
      const [cr,cg,cb] = rawColor.startsWith('#') ? _tlHexToRgb(rawColor) : [99,102,241];

      // Fade out dot during pause
      const dotOpacity = phase < sweepMs ? 1.0 : Math.max(0, 1 - (phase - sweepMs) / 800);

      if (dotOpacity <= 0) return;

      // â”€â”€ Line glow trail: illuminate nearby curve segments â”€â”€
      if (phase < sweepMs) {
        ctx.save();
        const glowRadius = 60; // pixels of illumination around the dot
        for (let pi = 0; pi < totalPts; pi++) {
          const pt = meta.data[pi];
          const dist = Math.sqrt((pt.x - x) ** 2 + (pt.y - y) ** 2);
          if (dist < glowRadius && pi < totalPts - 1) {
            const nextPt = meta.data[pi + 1];
            const intensity = 1 - dist / glowRadius;
            ctx.beginPath();
            ctx.moveTo(pt.x, pt.y);
            ctx.lineTo(nextPt.x, nextPt.y);
            ctx.strokeStyle = `rgba(${cr},${cg},${cb},${(intensity * 0.6).toFixed(2)})`;
            ctx.lineWidth = 4 + intensity * 4;
            ctx.shadowColor = `rgba(${cr},${cg},${cb},${(intensity * 0.5).toFixed(2)})`;
            ctx.shadowBlur = 12 + intensity * 12;
            ctx.stroke();
          }
        }
        ctx.restore();
      }

      // â”€â”€ Outer glow halo â”€â”€
      ctx.save();
      ctx.globalAlpha = dotOpacity;
      const glowSize = 36;
      const grad = ctx.createRadialGradient(x, y, 0, x, y, glowSize);
      grad.addColorStop(0, `rgba(${cr},${cg},${cb},0.8)`);
      grad.addColorStop(0.3, `rgba(${cr},${cg},${cb},0.35)`);
      grad.addColorStop(0.6, `rgba(${cr},${cg},${cb},0.1)`);
      grad.addColorStop(1, 'transparent');
      ctx.beginPath();
      ctx.arc(x, y, glowSize, 0, Math.PI * 2);
      ctx.fillStyle = grad;
      ctx.fill();

      // â”€â”€ Inner bright dot â”€â”€
      ctx.beginPath();
      ctx.arc(x, y, 5, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(255,255,255,${dotOpacity.toFixed(2)})`;
      ctx.shadowColor = `rgb(${cr},${cg},${cb})`;
      ctx.shadowBlur = 24;
      ctx.fill();
      ctx.restore();
    });
    // Request re-render for animation
    if (chart._tlRAF) cancelAnimationFrame(chart._tlRAF);
    chart._tlRAF = requestAnimationFrame(() => chart.draw());
  },
  beforeDestroy(chart) {
    if (chart._tlRAF) cancelAnimationFrame(chart._tlRAF);
  }
};

function buildCumulativePnL() {
  const trades = getFilteredTrades();
  const sorted = [...trades].sort((a,b) => a[0].localeCompare(b[0]));
  const dayMap = {};
  for (const [d, s, g] of sorted) {
    if (!dayMap[d]) dayMap[d] = 0;
    dayMap[d] += g;
  }
  const days = Object.keys(dayMap).sort();
  let cum = 0;
  const labels = [], values = [];
  for (const d of days) {
    cum += dayMap[d];
    labels.push(d.substring(5)); // MM-DD
    values.push(Math.round(cum * 100) / 100);
  }
  return new Chart(document.getElementById('pnlCumReal'), {
    type:'line',
    data: {
      labels,
      datasets: [{
        label:'P&L CumulÃ© (â‚¬)', data:values,
        borderColor:'#10b981', backgroundColor:'rgba(16,185,129,0.08)',
        borderWidth:2.5, fill:true, tension:0.3, pointRadius:3, pointHitRadius:8,
        pointBackgroundColor: values.map(v => v >= 0 ? '#10b981' : '#ef4444'),
        pointBorderColor: values.map(v => v >= 0 ? '#10b981' : '#ef4444')
      }]
    },
    options: {
      responsive:true,
      plugins:{
        legend:{display:false},
        tooltip:{backgroundColor:'#1a2235',borderColor:'#2d3a4d',borderWidth:1,
          callbacks:{label:c=>c.parsed.y.toFixed(2)+' â‚¬'}}
      },
      scales:{
        x:{ticks:{maxTicksLimit:20,font:{size:9}},grid:{display:false}},
        y:{ticks:{callback:v=>fmt(v)+' â‚¬'},grid:{color:'rgba(30,42,58,0.4)'}}
      }
    },
    plugins: [travelingLightPlugin]
  });
}

function buildAvgGainChart() {
  const trades = getFilteredTrades();
  const gains = trades.map(t => t[2]);
  const wins = gains.filter(g => g > 0);
  const losses = gains.filter(g => g <= 0);
  const maxGain = wins.length > 0 ? Math.max(...wins) : 0;
  const avgWin = wins.length > 0 ? wins.reduce((a,b)=>a+b,0)/wins.length : 0;
  const avgLoss = losses.length > 0 ? losses.reduce((a,b)=>a+b,0)/losses.length : 0;
  const maxLoss = losses.length > 0 ? Math.min(...losses) : 0;

  const labels = ['Gain max','Gain moyen','Perte moyenne','Perte max'];
  const values = [maxGain, avgWin, avgLoss, maxLoss];
  const colors = ['rgba(16,185,129,0.85)','rgba(16,185,129,0.5)','rgba(239,68,68,0.5)','rgba(239,68,68,0.85)'];

  return new Chart(document.getElementById('avgGainReal'), {
    type:'bar',
    data: {
      labels,
      datasets:[{
        data:values,
        backgroundColor:colors,
        borderRadius:6,
        barPercentage:0.65
      }]
    },
    options: {
      indexAxis:'y',
      responsive:true,
      layout:{ padding:{ right:80, left:10 } },
      plugins:{
        legend:{display:false},
        tooltip:{callbacks:{label:c=> (c.parsed.x>=0?'+':'')+c.parsed.x.toFixed(2)+' â‚¬'}}
      },
      scales:{
        x:{
          grid:{color:'rgba(30,42,58,0.4)'},
          ticks:{callback:v=>(v>=0?'+':'')+v.toFixed(0)+' â‚¬',color:'#8899aa',font:{size:10}}
        },
        y:{
          grid:{display:false},
          ticks:{color:'#ccc',font:{size:11,weight:'500'}}
        }
      }
    },
    plugins:[{
      id:'datalabels-avg',
      afterDatasetsDraw(chart) {
        const ctx = chart.ctx;
        chart.data.datasets[0].data.forEach((val, i) => {
          const meta = chart.getDatasetMeta(0).data[i];
          const barEnd = meta.x; // bout de la barre
          const barBase = meta.base; // point zÃ©ro
          ctx.save();
          ctx.font = 'bold 11px Inter, sans-serif';
          ctx.textBaseline = 'middle';
          ctx.fillStyle = val >= 0 ? '#10b981' : '#ef4444';
          const label = (val>=0?'+':'')+val.toFixed(2)+' â‚¬';
          const barWidth = Math.abs(barEnd - barBase);
          const textW = ctx.measureText(label).width;
          if (textW + 16 < barWidth) {
            // Texte Ã  l'intÃ©rieur de la barre
            ctx.fillStyle = '#fff';
            ctx.textAlign = val >= 0 ? 'right' : 'left';
            ctx.fillText(label, val >= 0 ? barEnd - 8 : barEnd + 8, meta.y);
          } else {
            // Texte Ã  l'extÃ©rieur, au bout de la barre
            ctx.textAlign = val >= 0 ? 'left' : 'right';
            ctx.fillText(label, val >= 0 ? barEnd + 8 : barEnd - 8, meta.y);
          }
          ctx.restore();
        });
      }
    }]
  });
}

function buildWinLossDay() {
  const trades = getFilteredTrades();
  const showEur = document.getElementById('winLossPctToggle') && document.getElementById('winLossPctToggle').checked;
  const dayWins = [0,0,0,0,0,0,0];
  const dayLosses = [0,0,0,0,0,0,0];
  const dayPnlPlus = [0,0,0,0,0,0,0];
  const dayPnlMinus = [0,0,0,0,0,0,0];
  for (const [d, s, g] of trades) {
    const dow = new Date(d).getDay();
    if (g > 0) { dayWins[dow]++; dayPnlPlus[dow] += g; }
    else { dayLosses[dow]++; dayPnlMinus[dow] += g; }
  }
  const dayNames = ['Lun','Mar','Mer','Jeu','Ven'];
  const idx = [1,2,3,4,5];

  if (showEur) {
    // Mode montant â‚¬ par jour
    const gainsData = idx.map(i => +dayPnlPlus[i].toFixed(2));
    const lossesData = idx.map(i => +dayPnlMinus[i].toFixed(2));
    const netData = idx.map(i => +(dayPnlPlus[i] + dayPnlMinus[i]).toFixed(2));

    return new Chart(document.getElementById('winLossDayReal'), {
      type:'bar',
      data: {
        labels: dayNames,
        datasets:[
          { label:'Gains', data:gainsData, backgroundColor:'rgba(16,185,129,0.75)', borderRadius:4, barPercentage:0.6 },
          { label:'Pertes', data:lossesData.map(v=>Math.abs(v)), backgroundColor:'rgba(239,68,68,0.75)', borderRadius:4, barPercentage:0.6 }
        ]
      },
      options: {
        responsive:true,
        layout:{ padding:{ top:25 } },
        plugins:{
          legend:{display:true,labels:{color:'#8899aa',font:{size:11},usePointStyle:true,pointStyle:'circle',padding:16}},
          tooltip:{callbacks:{label:c=>{
            const isGain = c.datasetIndex === 0;
            return c.dataset.label+': '+(isGain?'+':'-')+c.parsed.y.toFixed(2)+' â‚¬';
          }}}
        },
        scales:{
          x:{stacked:true, grid:{display:false}},
          y:{stacked:true, grid:{color:'rgba(30,42,58,0.4)'}, ticks:{callback:v=>v.toFixed(0)+' â‚¬', color:'#8899aa'}}
        }
      },
      plugins:[{
        id:'datalabels-eur',
        afterDatasetsDraw(chart) {
          const ctx = chart.ctx;
          // Net P&L au-dessus de chaque barre
          const topMeta = chart.getDatasetMeta(chart.data.datasets.length - 1);
          topMeta.data.forEach((bar, i) => {
            const net = netData[i];
            if (gainsData[i] === 0 && lossesData[i] === 0) return;
            ctx.save();
            ctx.font = 'bold 11px Inter, sans-serif';
            ctx.fillStyle = net >= 0 ? '#10b981' : '#ef4444';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            ctx.fillText((net>=0?'+':'')+net.toFixed(0)+' â‚¬', bar.x, bar.y - 6);
            ctx.restore();
          });
        }
      }]
    });
  } else {
    // Mode nombre (stacked) avec % rÃ©ussite au-dessus
    const winsData = idx.map(i => dayWins[i]);
    const lossesData = idx.map(i => dayLosses[i]);
    const winRates = idx.map(i => {
      const total = dayWins[i] + dayLosses[i];
      return total > 0 ? (dayWins[i] / total * 100) : 0;
    });

    return new Chart(document.getElementById('winLossDayReal'), {
      type:'bar',
      data: {
        labels: dayNames,
        datasets:[
          { label:'Gagnants', data:winsData, backgroundColor:'rgba(16,185,129,0.75)', borderRadius:4, barPercentage:0.6 },
          { label:'Perdants', data:lossesData, backgroundColor:'rgba(239,68,68,0.75)', borderRadius:4, barPercentage:0.6 }
        ]
      },
      options: {
        responsive:true,
        layout:{ padding:{ top:25 } },
        plugins:{
          legend:{display:true,labels:{color:'#8899aa',font:{size:11},usePointStyle:true,pointStyle:'circle',padding:16}},
          tooltip:{callbacks:{label:c=>c.dataset.label+': '+c.parsed.y+' trades'}}
        },
        scales:{
          x:{stacked:true, grid:{display:false}},
          y:{stacked:true, grid:{color:'rgba(30,42,58,0.4)'}, ticks:{stepSize:1, color:'#8899aa'}}
        }
      },
      plugins:[{
        id:'datalabels-stacked',
        afterDatasetsDraw(chart) {
          const ctx = chart.ctx;
          // Chiffres dans chaque segment
          chart.data.datasets.forEach((ds, dsIdx) => {
            const meta = chart.getDatasetMeta(dsIdx);
            meta.data.forEach((bar, i) => {
              const val = ds.data[i];
              if (val === 0) return;
              ctx.save();
              ctx.font = 'bold 11px Inter, sans-serif';
              ctx.fillStyle = '#fff';
              ctx.textAlign = 'center';
              ctx.textBaseline = 'middle';
              const yMid = (bar.y + bar.base) / 2;
              ctx.fillText(val, bar.x, yMid);
              ctx.restore();
            });
          });
          // % rÃ©ussite au-dessus de la barre
          const topMeta = chart.getDatasetMeta(chart.data.datasets.length - 1);
          topMeta.data.forEach((bar, i) => {
            const total = winsData[i] + lossesData[i];
            if (total === 0) return;
            const pct = winRates[i];
            ctx.save();
            ctx.font = 'bold 11px Inter, sans-serif';
            ctx.fillStyle = pct >= 50 ? '#10b981' : '#ef4444';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            ctx.fillText(pct.toFixed(0)+'%', bar.x, bar.y - 6);
            ctx.restore();
          });
        }
      }]
    });
  }
}

function rebuildWinLossDay() {
  if (realChartInstances['winLossDayReal']) {
    realChartInstances['winLossDayReal'].destroy();
    delete realChartInstances['winLossDayReal'];
  }
  realChartInstances['winLossDayReal'] = buildWinLossDay();
}

const REAL_INITIAL_CAPITAL = 7000; // Capital initial au 1er janv. 2026

// Compute running capital at start of a given month (cumulates all trades + adjustments before that month)
function capitalAtMonth(y, m) {
  const trades = getFilteredTrades();
  const prefix = `${y}-${String(m+1).padStart(2,'0')}`;
  let cap = REAL_INITIAL_CAPITAL;
  // Add adjustments before this month
  for (const a of capitalAdjustments) {
    if (a.date < prefix) cap += (a.type === 'deposit' ? a.amount : -a.amount);
  }
  // Add all trades before this month
  const sorted = [...trades].sort((a,b) => a[0].localeCompare(b[0]));
  for (const [d, s, g] of sorted) {
    if (d < prefix) cap += g;
    else break;
  }
  return cap;
}

function buildDailyCalendar() {
  const trades = getFilteredTrades();
  const dayData = aggregateByDay(trades);
  const showPct = document.getElementById('dayPctToggle') && document.getElementById('dayPctToggle').checked;
  const title = monthNamesFull[calMonth] + ' ' + calYear;
  document.getElementById('calTitle').textContent = title;

  const firstDay = new Date(calYear, calMonth, 1);
  const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
  // startDow for Mon-Fri grid (Mon=0..Fri=4)
  let startDow = firstDay.getDay();
  startDow = startDow === 0 ? 6 : startDow - 1; // Mon=0, Sun=6
  // Clamp to 0-4 for weekday-only grid
  if (startDow > 4) startDow = 0; // If month starts on Sat/Sun, first weekday is Mon

  // Capital at start of this month for % calculations
  const startCap = capitalAtMonth(calYear, calMonth);

  const today = new Date();
  const todayStr = today.getFullYear()+'-'+String(today.getMonth()+1).padStart(2,'0')+'-'+String(today.getDate()).padStart(2,'0');

  let html = '';
  ['Lun','Mar','Mer','Jeu','Ven'].forEach(d => {
    html += `<div class="day-header">${d}</div>`;
  });

  // Calculate the weekday offset for the first day
  const firstWeekday = firstDay.getDay();
  let offset = firstWeekday === 0 ? 4 : (firstWeekday === 6 ? 4 : firstWeekday - 1);
  // offset = number of empty cells before day 1 in Mon-Fri grid
  // Mon=0, Tue=1, Wed=2, Thu=3, Fri=4
  if (firstWeekday === 1) offset = 0;
  else if (firstWeekday === 2) offset = 1;
  else if (firstWeekday === 3) offset = 2;
  else if (firstWeekday === 4) offset = 3;
  else if (firstWeekday === 5) offset = 4;
  else if (firstWeekday === 6) offset = 0; // Sat â†’ next Mon is day 3
  else if (firstWeekday === 0) offset = 0; // Sun â†’ next Mon is day 2

  // Better approach: find which weekday column day 1 falls on
  for (let i = 0; i < offset; i++) html += '<div class="day-cell empty"></div>';

  let totalWinDays = 0, totalLossDays = 0, totalTradeDays = 0;
  let runningCap = startCap;

  // Pre-compute max absolute gain of the month for gradient intensity
  const monthPnls = Object.entries(dayData)
    .filter(([d]) => d.startsWith(`${calYear}-${String(calMonth+1).padStart(2,'0')}`))
    .map(([,v]) => Math.abs(v.pnl));
  const maxAbsPnl = monthPnls.length > 0 ? Math.max(...monthPnls) : 1;

  for (let d = 1; d <= daysInMonth; d++) {
    const dateObj = new Date(calYear, calMonth, d);
    const dow = dateObj.getDay(); // 0=Sun, 6=Sat
    if (dow === 0 || dow === 6) continue; // Skip weekends

    const dateStr = `${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const data = dayData[dateStr];
    const isToday = dateStr === todayStr;

    if (data) {
      totalTradeDays++;
      if (data.pnl >= 0) totalWinDays++; else totalLossDays++;
      const cls = data.pnl >= 0 ? 'win' : 'loss';
      const sign = data.pnl >= 0 ? '+' : '';
      let displayVal;
      if (showPct) {
        const pct = runningCap > 0 ? (data.pnl / runningCap * 100) : 0;
        displayVal = `${sign}${pct.toFixed(2)}%`;
      } else {
        displayVal = `${sign}${data.pnl.toFixed(0)}â‚¬`;
      }
      runningCap += data.pnl;
      // Gradient intensity: 0.08 (min) to 0.45 (max) proportional to |pnl|
      const intensity = maxAbsPnl > 0 ? 0.08 + (Math.abs(data.pnl) / maxAbsPnl) * 0.37 : 0.12;
      const bgColor = data.pnl >= 0
        ? `rgba(16,185,129,${intensity.toFixed(2)})`
        : `rgba(239,68,68,${intensity.toFixed(2)})`;
      html += `<div class="day-cell ${cls} ${isToday?'today':''}" style="background:${bgColor}">
        <span class="day-num">${d}</span>
        <span class="day-pnl">${displayVal}</span>
        <span class="day-trades">${data.trades} trade${data.trades>1?'s':''}</span>
      </div>`;
    } else {
      html += `<div class="day-cell no-trade ${isToday?'today':''}"><span class="day-num">${d}</span></div>`;
    }
  }
  document.getElementById('dayGrid').innerHTML = html;

  const winPct = totalTradeDays > 0 ? (totalWinDays/totalTradeDays*100).toFixed(0) : '0';
  const lossPct = totalTradeDays > 0 ? (totalLossDays/totalTradeDays*100).toFixed(0) : '0';
  const prefix = `${calYear}-${String(calMonth+1).padStart(2,'0')}`;
  const monthTotal = Object.entries(dayData)
    .filter(([d]) => d.startsWith(prefix))
    .reduce((a, [,v]) => a + v.pnl, 0);
  const monthPct = startCap > 0 ? (monthTotal / startCap * 100).toFixed(2) : '0';
  const monthDisplay = showPct
    ? `${monthTotal>=0?'+':''}${monthPct}%`
    : `${monthTotal>=0?'+':''}${monthTotal.toFixed(2)} â‚¬`;
  document.getElementById('dayStats').innerHTML = `
    <div class="stat-item"><span class="stat-dot green"></span>${totalWinDays} jours gagnants (${winPct}%)</div>
    <div class="stat-item"><span class="stat-dot red"></span>${totalLossDays} jours perdants (${lossPct}%)</div>
    <div class="stat-item"><strong>P&L du mois :</strong>&nbsp;<span style="color:${monthTotal>=0?'var(--positive)':'var(--negative)'}; font-weight:700">${monthDisplay}</span></div>
    <div class="stat-item" style="color:var(--text-secondary);font-size:0.72rem;">Capital dÃ©but mois : ${fmt(Math.round(startCap))} â‚¬</div>
  `;
}

function calPrev() { calMonth--; if(calMonth<0){calMonth=11;calYear--;} buildDailyCalendar(); }
function calNext() { calMonth++; if(calMonth>11){calMonth=0;calYear++;} buildDailyCalendar(); }

function buildMonthlyHeatReal() {
  const trades = getFilteredTrades();
  const monthData = aggregateByMonth(trades);
  const showPct = document.getElementById('monthPctToggle') && document.getElementById('monthPctToggle').checked;
  const years = [...new Set(trades.map(t => parseInt(t[0].substring(0,4))))].sort((a,b) => b-a);

  const mh = ['AnnÃ©e', ...monthNames, 'Total'];
  let html = '<table class="heatmap-table"><thead><tr>' + mh.map(h=>`<th>${h}</th>`).join('') + '</tr></thead><tbody>';

  let totalWinMonths = 0, totalLossMonths = 0, totalMonths = 0;
  for (const y of years) {
    html += '<tr><td class="year-cell">' + y + '</td>';
    let yearTotal = 0, yearTotalPct = 0;
    for (let m = 0; m < 12; m++) {
      const key = `${y}-${String(m+1).padStart(2,'0')}`;
      const data = monthData[key];
      if (data) {
        totalMonths++;
        if (data.pnl >= 0) totalWinMonths++; else totalLossMonths++;
        yearTotal += data.pnl;
        const capStart = capitalAtMonth(y, m);
        const pct = capStart > 0 ? (data.pnl / capStart * 100) : 0;
        yearTotalPct += pct;
        const intensityRef = showPct ? Math.abs(pct) / 8 : Math.abs(data.pnl) / 500;
        const intensity = Math.min(intensityRef, 1);
        const bg = data.pnl >= 0
          ? `rgba(16,185,129,${(0.12 + intensity * 0.55).toFixed(2)})`
          : `rgba(239,68,68,${(0.12 + intensity * 0.55).toFixed(2)})`;
        const c = data.pnl >= 0 ? '#10b981' : '#ef4444';
        const sign = data.pnl >= 0 ? '+' : '';
        const displayVal = showPct ? `${sign}${pct.toFixed(1)}%` : `${sign}${data.pnl.toFixed(0)}â‚¬`;
        html += `<td style="background:${bg};color:${c};" title="${data.trades} trades â€” ${sign}${data.pnl.toFixed(2)}â‚¬">${displayVal}</td>`;
      } else {
        html += '<td style="background:rgba(30,42,58,0.2);color:#444;">â€”</td>';
      }
    }
    const totVal = showPct ? yearTotalPct : yearTotal;
    const tI = Math.min(Math.abs(showPct ? yearTotalPct/10 : yearTotal/1000), 1);
    const totBg = totVal >= 0
      ? `rgba(16,185,129,${(0.12+tI*0.55).toFixed(2)})`
      : `rgba(239,68,68,${(0.12+tI*0.55).toFixed(2)})`;
    const totC = totVal >= 0 ? '#10b981' : '#ef4444';
    const totDisplay = showPct ? `${totVal>=0?'+':''}${totVal.toFixed(1)}%` : `${totVal>=0?'+':''}${totVal.toFixed(0)}â‚¬`;
    html += `<td class="total-cell" style="background:${totBg};color:${totC};">${totDisplay}</td></tr>`;
  }
  html += '</tbody></table>';
  document.getElementById('monthlyHeatReal').innerHTML = html;

  const winPct = totalMonths > 0 ? (totalWinMonths/totalMonths*100).toFixed(0) : '0';
  const lossPct = totalMonths > 0 ? (totalLossMonths/totalMonths*100).toFixed(0) : '0';
  document.getElementById('monthStats').innerHTML = `
    <div class="stat-item"><span class="stat-dot green"></span>${totalWinMonths} mois gagnants (${winPct}%)</div>
    <div class="stat-item"><span class="stat-dot red"></span>${totalLossMonths} mois perdants (${lossPct}%)</div>
  `;
}

// â”€â”€ CSV Modal â”€â”€
let pendingCsvText = '';

function openCsvModal() {
  document.getElementById('csvModal').classList.add('show');
  pendingCsvText = '';
  document.getElementById('csvFileInput').value = '';
  document.getElementById('fileSelectedName').style.display = 'none';
  document.getElementById('btnApplyCsv').disabled = true;
  document.getElementById('fileDropZone').classList.remove('dragover');
}
function closeCsvModal() {
  document.getElementById('csvModal').classList.remove('show');
  pendingCsvText = '';
}

// Drag & Drop
document.addEventListener('DOMContentLoaded', () => {
  const zone = document.getElementById('fileDropZone');
  if (!zone) return;
  zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
  zone.addEventListener('drop', e => {
    e.preventDefault(); zone.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) readCsvFile(e.dataTransfer.files[0]);
  });
});

function handleFileSelect(input) {
  if (input.files.length > 0) readCsvFile(input.files[0]);
}

function readCsvFile(file) {
  const reader = new FileReader();
  reader.onload = e => {
    pendingCsvText = e.target.result;
    const nameEl = document.getElementById('fileSelectedName');
    nameEl.textContent = 'âœ… ' + file.name + ' (' + (file.size/1024).toFixed(1) + ' Ko)';
    nameEl.style.display = 'block';
    document.getElementById('btnApplyCsv').disabled = false;
  };
  reader.readAsText(file, 'windows-1252');
}

function tradeKey(t) {
  return t[0] + '|' + t[1] + '|' + t[2].toFixed(2);
}

function applyCsv() {
  if (!pendingCsvText) return;
  const parsed = parseCsvText(pendingCsvText);
  if (parsed.length === 0) {
    alert('Aucun trade trouvÃ©. VÃ©rifiez le format du fichier (sÃ©parateur tabulation, export IG).');
    return;
  }
  // Delta : fusionner avec les trades existants sans doublons
  const existingKeys = new Set(realTrades.map(t => tradeKey(t)));
  const newTrades = parsed.filter(t => !existingKeys.has(tradeKey(t)));
  const merged = [...realTrades, ...newTrades].sort((a,b) => b[0].localeCompare(a[0]));
  realTrades = merged;
  saveTradesToFirebase(merged);
  // Positionner le calendrier sur le mois le plus rÃ©cent
  const latest = merged[0][0];
  calYear = parseInt(latest.substring(0,4));
  calMonth = parseInt(latest.substring(5,7)) - 1;
  renderRealTab();
  closeCsvModal();
  // Message rÃ©capitulatif
  const msg = newTrades.length > 0
    ? `âœ… ${newTrades.length} nouveau(x) trade(s) ajoutÃ©(s), ${parsed.length - newTrades.length} doublon(s) ignorÃ©(s).`
    : `â„¹ï¸ Aucun nouveau trade â€” les ${parsed.length} trades du fichier Ã©taient dÃ©jÃ  en base.`;
  setTimeout(() => alert(msg), 300);
}

function stripAccents(str) {
  return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
}

function parseCsvText(csvText) {
  const lines = csvText.trim().split('\n');
  const trades = [];
  const frMonths = {'janv':0,'fevr':1,'mars':2,'avr':3,'mai':4,'juin':5,
                    'juil':6,'aout':7,'sept':8,'oct':9,'nov':10,'dec':11};
  for (let i = 1; i < lines.length; i++) {
    const cols = lines[i].split('\t').map(c => c.replace(/^"|"$/g, ''));
    if (cols.length < 8) continue;
    const gain = cols[7];
    if (!gain || gain === '-' || gain.trim() === '-') continue;
    // Nettoyer le gain : enlever â‚¬, espaces, remplacer , par .
    const cleaned = gain.replace(/[â‚¬\s\u00a0]/g, '').replace(',', '.');
    const isNeg = cleaned.startsWith('-');
    const gainNum = parseFloat(cleaned.replace(/[+-]/g, ''));
    if (isNaN(gainNum)) continue;
    // Parser la date franÃ§aise : "26 fÃ©vr. 2026, 16:19:27"
    const dateParts = cols[0].trim().split(/[\s,]+/);
    if (dateParts.length < 3) continue;
    const day = parseInt(dateParts[0]);
    const monthStr = stripAccents(dateParts[1].replace('.', '').toLowerCase());
    const year = parseInt(dateParts[2]);
    const month = frMonths[monthStr];
    if (isNaN(day) || month === undefined || isNaN(year)) continue;
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    trades.push([dateStr, cols[2], isNeg ? -gainNum : gainNum]);
  }
  return trades;
}

// â”€â”€ Drawdown Chart â”€â”€
function buildDrawdownChart() {
  // Compute drawdown series for a set of trades
  function computeDrawdown(trades, initialCap) {
    const sorted = [...trades].sort((a,b) => a[0].localeCompare(b[0]));
    const dayMap = {};
    for (const [d, , g] of sorted) {
      if (!dayMap[d]) dayMap[d] = 0;
      dayMap[d] += g;
    }
    const days = Object.keys(dayMap).sort();
    let equity = initialCap;
    let peak = initialCap;
    const labels = [], values = [];
    for (const d of days) {
      equity += dayMap[d];
      if (equity > peak) peak = equity;
      const dd = peak > 0 ? ((equity - peak) / peak) * 100 : 0;
      labels.push(d.substring(5)); // MM-DD
      values.push(Math.round(dd * 100) / 100);
    }
    return { labels, values };
  }

  const totalAdj = getTotalAdjustments();
  const initCap = REAL_INITIAL_CAPITAL + totalAdj;

  // Compute for all, DAX, NASDAQ
  const allData = computeDrawdown(realTrades, initCap);

  const daxTrades = realTrades.filter(t => t[1] === 'DAX');
  const nasTrades = realTrades.filter(t => t[1] === 'NASDAQ');

  // Use same timeline (allData.labels) for alignment
  const masterDays = allData.labels;

  // For per-asset: compute full series then align to master labels
  function alignToMaster(trades) {
    const sorted = [...trades].sort((a,b) => a[0].localeCompare(b[0]));
    const dayMap = {};
    for (const [d, , g] of sorted) {
      if (!dayMap[d]) dayMap[d] = 0;
      dayMap[d] += g;
    }
    // Need full dates for alignment
    const allSorted = [...realTrades].sort((a,b) => a[0].localeCompare(b[0]));
    const allDayMap = {};
    for (const [d] of allSorted) {
      if (!allDayMap[d]) allDayMap[d] = true;
    }
    const allDays = Object.keys(allDayMap).sort();

    let equity = initCap;
    let peak = initCap;
    const result = [];
    for (const d of allDays) {
      if (dayMap[d]) equity += dayMap[d];
      if (equity > peak) peak = equity;
      const dd = peak > 0 ? ((equity - peak) / peak) * 100 : 0;
      result.push(Math.round(dd * 100) / 100);
    }
    return result;
  }

  const daxValues = alignToMaster(daxTrades);
  const nasValues = alignToMaster(nasTrades);

  const datasets = [
    {
      label: 'Global',
      data: allData.values,
      borderColor: '#a78bfa',
      backgroundColor: 'rgba(167,139,250,0.08)',
      borderWidth: 2,
      fill: true,
      tension: 0.3,
      pointRadius: 0,
      pointHitRadius: 6
    }
  ];

  // Add DAX line if trades exist
  if (daxTrades.length > 0) {
    datasets.push({
      label: 'DAX',
      data: daxValues,
      borderColor: '#6366f1',
      backgroundColor: 'transparent',
      borderWidth: 1.5,
      borderDash: [],
      fill: false,
      tension: 0.3,
      pointRadius: 0,
      pointHitRadius: 6
    });
  }

  // Add NASDAQ line if trades exist
  if (nasTrades.length > 0) {
    datasets.push({
      label: 'NASDAQ',
      data: nasValues,
      borderColor: '#06b6d4',
      backgroundColor: 'transparent',
      borderWidth: 1.5,
      borderDash: [],
      fill: false,
      tension: 0.3,
      pointRadius: 0,
      pointHitRadius: 6
    });
  }

  return new Chart(document.getElementById('drawdownReal'), {
    type: 'line',
    data: { labels: masterDays, datasets },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: true,
          labels: { color: '#8899aa', font: { size: 11 }, usePointStyle: true, pointStyle: 'line', padding: 16 }
        },
        tooltip: {
          backgroundColor: '#1a2235',
          borderColor: '#2d3a4d',
          borderWidth: 1,
          callbacks: { label: c => c.dataset.label + ' : ' + c.parsed.y.toFixed(2) + '%' }
        }
      },
      scales: {
        x: { ticks: { maxTicksLimit: 20, font: { size: 9 }, color: '#8899aa' }, grid: { display: false } },
        y: {
          max: 0,
          ticks: { callback: v => v.toFixed(1) + '%', color: '#8899aa' },
          grid: { color: 'rgba(30,42,58,0.4)' }
        }
      }
    },
    plugins: [travelingLightPlugin]
  });
}

// â”€â”€ Real Tab Rendering â”€â”€
const realChartInstances = {};
function destroyRealCharts() {
  ['pnlCumReal','avgGainReal','winLossDayReal','drawdownReal'].forEach(k => {
    if (realChartInstances[k]) { realChartInstances[k].destroy(); delete realChartInstances[k]; }
  });
}
function renderRealTab() {
  destroyRealCharts();
  buildRealKPIs();
  realChartInstances['pnlCumReal'] = buildCumulativePnL();
  realChartInstances['avgGainReal'] = buildAvgGainChart();
  realChartInstances['winLossDayReal'] = buildWinLossDay();
  buildDailyCalendar();
  buildMonthlyHeatReal();
  realChartInstances['drawdownReal'] = buildDrawdownChart();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERIOD STATE per tab
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const periodState = {
  fixed:    { startIdx: 0, endIdx: ALL_MONTHS.length - 1, capital: 10000 },
  reinvest: { startIdx: 0, endIdx: ALL_MONTHS.length - 1, capital: 10000 }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS â€” now period-aware
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getSlice(startIdx, endIdx) {
  return ALL_MONTHS.slice(startIdx, endIdx + 1);
}

function getVal(data, ym) { return data[ym.y][ym.m]; }

function buildTimeline(data, slice) {
  const labels = [], values = [];
  for (const ym of slice) {
    labels.push(mLabel(ym));
    values.push(getVal(data, ym));
  }
  return { labels, values };
}

function computeEquity(data, start, slice) {
  const tl = buildTimeline(data, slice);
  let cap = start;
  const eq = [start], labels = ['DÃ©part'];
  for (let i = 0; i < tl.values.length; i++) {
    cap *= (1 + tl.values[i] / 100);
    eq.push(cap);
    labels.push(tl.labels[i]);
  }
  return { labels, equity: eq };
}

function computeDrawdown(arr) {
  let peak = arr[0];
  return arr.map(v => { if (v > peak) peak = v; return ((v - peak) / peak) * 100; });
}

function annualTotals(data, slice) {
  const r = {};
  for (const ym of slice) {
    if (!r[ym.y]) r[ym.y] = 1;
    r[ym.y] *= (1 + getVal(data, ym) / 100);
  }
  for (const y in r) r[y] = (r[y] - 1) * 100;
  return r;
}

function mergedTimeline(d1, d2, slice) {
  const labels = [], values = [];
  for (const ym of slice) {
    labels.push(mLabel(ym));
    values.push((getVal(d1, ym) + getVal(d2, ym)) / 2);
  }
  return { labels, values };
}

function rolling12(labels, values) {
  const rl = [], rv = [];
  for (let i = 11; i < values.length; i++) {
    let p = 1;
    for (let j = i - 11; j <= i; j++) p *= (1 + values[j] / 100);
    rl.push(labels[i]);
    rv.push((p - 1) * 100);
  }
  return { labels: rl, values: rv };
}

function fmt(n) { return Math.round(n).toLocaleString('fr'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHART DEFAULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Chart.defaults.color = '#8899aa';
Chart.defaults.borderColor = 'rgba(30,42,58,0.5)';
Chart.defaults.font.family = 'Inter, sans-serif';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHART BUILDERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildKPIs(containerId, daxD, nasD, slice, totalCapital) {
  const half = totalCapital / 2;
  const dE = computeEquity(daxD, half, slice), nE = computeEquity(nasD, half, slice);
  const fD = dE.equity.at(-1), fN = nE.equity.at(-1);
  const pD = ((fD - half) / half * 100).toFixed(1);
  const pN = ((fN - half) / half * 100).toFixed(1);
  const comb = fD + fN;
  const pC = ((comb - totalCapital) / totalCapital * 100).toFixed(1);
  const ddD = Math.min(...computeDrawdown(dE.equity)).toFixed(1);
  const ddN = Math.min(...computeDrawdown(nE.equity)).toFixed(1);
  const combEq = dE.equity.map((v,i) => v + nE.equity[i]);
  const ddC = Math.min(...computeDrawdown(combEq)).toFixed(1);
  const nbMonths = slice.length;
  const halfFmt = fmt(half);

  const capDColor = fD >= half ? 'var(--positive)' : 'var(--negative)';
  const capNColor = fN >= half ? 'var(--positive)' : 'var(--negative)';
  const capCColor = comb >= totalCapital ? 'var(--positive)' : 'var(--negative)';
  const kpis = [
    { l:'Capital DAX 40', v:`${fmt(fD)} â‚¬`, s:`${pD>=0?'+':''}${pD}%`, c:'stripe-dax', vc:capDColor },
    { l:'Capital NASDAQ 100', v:`${fmt(fN)} â‚¬`, s:`${pN>=0?'+':''}${pN}%`, c:'stripe-nas', vc:capNColor },
    { l:'Capital CombinÃ©', v:`${fmt(comb)} â‚¬`, s:`${pC>=0?'+':''}${pC}% (2Ã—${halfFmt}â‚¬)`, c:'stripe-merged', vc:capCColor },
    { l:'Max DD DAX', v:`${ddD}%`, s:'Depuis le plus haut', c:'stripe-dax', vc:'var(--negative)' },
    { l:'Max DD NASDAQ', v:`${ddN}%`, s:'Depuis le plus haut', c:'stripe-nas', vc:'var(--negative)' },
    { l:'Max DD CombinÃ©', v:`${ddC}%`, s:`${nbMonths} mois analysÃ©s`, c:'stripe-merged', vc:'var(--negative)' },
  ];
  document.getElementById(containerId).innerHTML = kpis.map(k =>
    `<div class="kpi-card"><div class="stripe ${k.c}"></div><div class="label">${k.l}</div><div class="value" style="color:${k.vc}">${k.v}</div><div class="sub">${k.s}</div></div>`
  ).join('');
}

function buildEquity(canvasId, daxD, nasD, slice, totalCapital) {
  const half = totalCapital / 2;
  const dE = computeEquity(daxD, half, slice), nE = computeEquity(nasD, half, slice);
  const cE = dE.equity.map((v,i) => v + nE.equity[i]);
  return new Chart(document.getElementById(canvasId), {
    type:'line',
    data: {
      labels: dE.labels,
      datasets: [
        { label:`CombinÃ© (2Ã—${fmt(half)}â‚¬)`, data:cE, borderColor:'#a78bfa', backgroundColor:'rgba(167,139,250,0.08)', borderWidth:2.5, fill:true, tension:0.3, pointRadius:0, pointHitRadius:8 },
        { label:'DAX 40', data:dE.equity, borderColor:'#6366f1', backgroundColor:'rgba(99,102,241,0.06)', borderWidth:2, fill:true, tension:0.3, pointRadius:0, pointHitRadius:8 },
        { label:'NASDAQ 100', data:nE.equity, borderColor:'#06b6d4', backgroundColor:'rgba(6,182,212,0.06)', borderWidth:2, fill:true, tension:0.3, pointRadius:0, pointHitRadius:8 }
      ]
    },
    options: {
      responsive:true, interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{labels:{usePointStyle:true,padding:20}},
        tooltip:{backgroundColor:'#1a2235',borderColor:'#2d3a4d',borderWidth:1, callbacks:{label:c=>`${c.dataset.label}: ${fmt(c.parsed.y)} â‚¬`}}
      },
      scales:{
        x:{ticks:{maxTicksLimit:20,font:{size:10}},grid:{display:false}},
        y:{ticks:{callback:v=>fmt(v)+' â‚¬',font:{size:11}},grid:{color:'rgba(30,42,58,0.4)'}}
      }
    }
  });
}

function buildAnnual(canvasId, daxD, nasD, slice) {
  const dA = annualTotals(daxD, slice), nA = annualTotals(nasD, slice);
  const yrs = Object.keys(dA).sort();
  return new Chart(document.getElementById(canvasId), {
    type:'bar',
    data: {
      labels: yrs,
      datasets: [
        { label:'DAX 40', data:yrs.map(y=>dA[y]), backgroundColor:'rgba(99,102,241,0.7)', borderRadius:6, barPercentage:0.7 },
        { label:'NASDAQ 100', data:yrs.map(y=>nA[y]||0), backgroundColor:'rgba(6,182,212,0.7)', borderRadius:6, barPercentage:0.7 },
        { label:'Moyenne', data:yrs.map(y=>((dA[y]||0)+(nA[y]||0))/2), backgroundColor:'rgba(167,139,250,0.6)', borderRadius:6, barPercentage:0.7 }
      ]
    },
    options: {
      responsive:true,
      plugins:{legend:{labels:{usePointStyle:true,padding:16}},tooltip:{callbacks:{label:c=>`${c.dataset.label}: ${c.parsed.y.toFixed(2)}%`}}},
      scales:{x:{grid:{display:false}},y:{ticks:{callback:v=>v.toFixed(0)+'%'},grid:{color:'rgba(30,42,58,0.4)'}}}
    }
  });
}

function buildMonthlyBar(canvasId, data, slice) {
  const tl = buildTimeline(data, slice);
  return new Chart(document.getElementById(canvasId), {
    type:'bar',
    data: {
      labels: tl.labels,
      datasets:[{data:tl.values, backgroundColor:tl.values.map(v=>v>=0?'rgba(16,185,129,0.7)':'rgba(239,68,68,0.7)'), borderRadius:3, barPercentage:0.85}]
    },
    options: {
      responsive:true,
      plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>c.parsed.y.toFixed(2)+'%'}}},
      scales:{x:{ticks:{maxTicksLimit:24,font:{size:9}},grid:{display:false}},y:{ticks:{callback:v=>v+'%'},grid:{color:'rgba(30,42,58,0.4)'}}}
    }
  });
}

function buildCombinedMonthly(canvasId, daxD, nasD, slice) {
  const m = mergedTimeline(daxD, nasD, slice);
  return new Chart(document.getElementById(canvasId), {
    type:'bar',
    data: {
      labels: m.labels,
      datasets:[{data:m.values, backgroundColor:m.values.map(v=>v>=0?'rgba(167,139,250,0.7)':'rgba(239,68,68,0.6)'), borderRadius:3, barPercentage:0.85}]
    },
    options: {
      responsive:true,
      plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>c.parsed.y.toFixed(2)+'%'}}},
      scales:{x:{ticks:{maxTicksLimit:24,font:{size:9}},grid:{display:false}},y:{ticks:{callback:v=>v+'%'},grid:{color:'rgba(30,42,58,0.4)'}}}
    }
  });
}

function buildRolling12(canvasId, daxD, nasD, slice) {
  const dT = buildTimeline(daxD, slice), nT = buildTimeline(nasD, slice);
  const dR = rolling12(dT.labels, dT.values), nR = rolling12(nT.labels, nT.values);
  if (dR.labels.length === 0) {
    // Not enough data for rolling 12m
    const ctx = document.getElementById(canvasId).getContext('2d');
    ctx.fillStyle = '#8899aa';
    ctx.font = '14px Inter';
    ctx.textAlign = 'center';
    ctx.fillText('PÃ©riode trop courte pour le glissant 12 mois', ctx.canvas.width/2, 100);
    return null;
  }
  return new Chart(document.getElementById(canvasId), {
    type:'line',
    data: {
      labels: dR.labels,
      datasets: [
        { label:'DAX 40', data:dR.values, borderColor:'#6366f1', borderWidth:2, tension:0.3, pointRadius:0, fill:false },
        { label:'NASDAQ 100', data:nR.values, borderColor:'#06b6d4', borderWidth:2, tension:0.3, pointRadius:0, fill:false }
      ]
    },
    options: {
      responsive:true, interaction:{mode:'index',intersect:false},
      plugins:{legend:{labels:{usePointStyle:true,padding:16}},tooltip:{callbacks:{label:c=>`${c.dataset.label}: ${c.parsed.y.toFixed(1)}%`}}},
      scales:{x:{ticks:{maxTicksLimit:20,font:{size:9}},grid:{display:false}},y:{ticks:{callback:v=>v.toFixed(0)+'%'},grid:{color:'rgba(30,42,58,0.4)'}}}
    }
  });
}

function buildDrawdown(canvasId, daxD, nasD, slice, totalCapital) {
  const half = totalCapital / 2;
  const dE = computeEquity(daxD, half, slice), nE = computeEquity(nasD, half, slice);
  const cE = dE.equity.map((v,i) => v + nE.equity[i]);
  return new Chart(document.getElementById(canvasId), {
    type:'line',
    data: {
      labels: dE.labels,
      datasets: [
        { label:'CombinÃ©', data:computeDrawdown(cE), borderColor:'#a78bfa', backgroundColor:'rgba(167,139,250,0.1)', borderWidth:2, fill:true, tension:0.3, pointRadius:0 },
        { label:'DAX 40', data:computeDrawdown(dE.equity), borderColor:'#6366f1', backgroundColor:'rgba(99,102,241,0.06)', borderWidth:1.5, fill:true, tension:0.3, pointRadius:0 },
        { label:'NASDAQ 100', data:computeDrawdown(nE.equity), borderColor:'#06b6d4', backgroundColor:'rgba(6,182,212,0.06)', borderWidth:1.5, fill:true, tension:0.3, pointRadius:0 }
      ]
    },
    options: {
      responsive:true, interaction:{mode:'index',intersect:false},
      plugins:{legend:{labels:{usePointStyle:true,padding:16}},tooltip:{callbacks:{label:c=>`${c.dataset.label}: ${c.parsed.y.toFixed(2)}%`}}},
      scales:{x:{ticks:{maxTicksLimit:20,font:{size:10}},grid:{display:false}},y:{ticks:{callback:v=>v.toFixed(0)+'%'},grid:{color:'rgba(30,42,58,0.4)'}}}
    }
  });
}

// â”€â”€ HEATMAP â”€â”€
function heatColor(val) {
  const intensity = Math.min(Math.abs(val) / 15, 1);
  if (val >= 0) return `rgba(16,185,129,${0.12 + intensity * 0.55})`;
  return `rgba(239,68,68,${0.12 + intensity * 0.55})`;
}

function buildHeatmap(containerId, data, slice) {
  // Build a Set of active ym keys
  const activeSet = new Set();
  for (const ym of slice) activeSet.add(ym.y + '-' + ym.m);

  // Get year range from slice
  const years = [...new Set(slice.map(s => s.y))].sort((a,b) => b-a);

  const mh = ['AnnÃ©e', ...monthNames, 'Total'];
  let html = '<table class="heatmap-table"><thead><tr>' + mh.map(h=>`<th>${h}</th>`).join('') + '</tr></thead><tbody>';
  for (const y of years) {
    html += '<tr><td class="year-cell">' + y + '</td>';
    let prod = 1;
    let hasActive = false;
    for (let m = 0; m < 12; m++) {
      const key = y + '-' + m;
      if (activeSet.has(key)) {
        const v = data[y][m];
        prod *= (1 + v / 100);
        hasActive = true;
        const c = v >= 0 ? '#10b981' : '#ef4444';
        html += `<td style="background:${heatColor(v)};color:${c};">${v>0?'+':''}${v.toFixed(2)}%</td>`;
      } else {
        html += '<td style="background:rgba(30,42,58,0.2);color:#444;">â€”</td>';
      }
    }
    const tot = hasActive ? (prod - 1) * 100 : 0;
    const tc = tot >= 0 ? '#10b981' : '#ef4444';
    html += `<td class="total-cell" style="background:${heatColor(tot)};color:${tc};">${tot>0?'+':''}${tot.toFixed(2)}%</td></tr>`;
  }
  html += '</tbody></table>';
  document.getElementById(containerId).innerHTML = html;
}

function buildMergedHeatmap(containerId, d1, d2, slice) {
  const merged = {};
  for (let y = 2017; y <= 2026; y++) { merged[y] = []; for (let m = 0; m < 12; m++) merged[y][m] = (d1[y][m] + d2[y][m]) / 2; }
  buildHeatmap(containerId, merged, slice);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERIOD SELECTOR â€” dual handle timeline
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initTimeline(tabName) {
  const suffix = tabName === 'fixed' ? 'Fixed' : 'Reinvest';
  const track = document.getElementById('track' + suffix);
  const fill = document.getElementById('fill' + suffix);
  const hStart = document.getElementById('handleStart' + suffix);
  const hEnd = document.getElementById('handleEnd' + suffix);
  const tipStart = document.getElementById('tipStart' + suffix);
  const tipEnd = document.getElementById('tipEnd' + suffix);
  const summary = document.getElementById('summary' + suffix);
  const labelsContainer = document.getElementById('labels' + suffix);
  const presetsContainer = document.getElementById('presets' + suffix);

  const total = ALL_MONTHS.length;
  const state = periodState[tabName];

  // â”€â”€ Year labels underneath â”€â”€
  let labelsHtml = '';
  for (let i = 0; i < total; i++) {
    const ym = ALL_MONTHS[i];
    const isJan = ym.m === 0;
    const isDec2017 = ym.y === 2017 && ym.m === 11;
    if (isJan || isDec2017) {
      labelsHtml += `<span class="year-mark" style="position:absolute;left:${(i / (total-1)) * 100}%;transform:translateX(-50%);">${isDec2017 ? '2017' : ym.y}</span>`;
    }
  }
  labelsContainer.style.position = 'relative';
  labelsContainer.style.height = '20px';
  labelsContainer.innerHTML = labelsHtml;

  // â”€â”€ Presets â”€â”€
  const presets = [
    { label: 'Tout', s: 0, e: total - 1 },
    { label: '1 an', s: total - 13, e: total - 1 },
    { label: '2 ans', s: total - 25, e: total - 1 },
    { label: '3 ans', s: total - 37, e: total - 1 },
    { label: '5 ans', s: total - 61, e: total - 1 },
    { label: '2024-25', s: ALL_MONTHS.findIndex(m=>m.y===2024&&m.m===0), e: ALL_MONTHS.findIndex(m=>m.y===2025&&m.m===11) },
    { label: '2020-22', s: ALL_MONTHS.findIndex(m=>m.y===2020&&m.m===0), e: ALL_MONTHS.findIndex(m=>m.y===2022&&m.m===11) },
  ];
  presetsContainer.innerHTML = presets.map((p, i) =>
    `<button class="preset-btn ${i===0?'active':''}" data-tab="${tabName}" data-s="${Math.max(0,p.s)}" data-e="${Math.min(total-1,p.e)}">${p.label}</button>`
  ).join('');

  presetsContainer.querySelectorAll('.preset-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const s = +btn.dataset.s, e = +btn.dataset.e;
      state.startIdx = s;
      state.endIdx = e;
      updateUI();
      renderTabCharts(tabName);
      // active style
      presetsContainer.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    });
  });

  function posFromIdx(idx) { return (idx / (total - 1)) * 100; }
  function idxFromPos(pct) { return Math.round(pct / 100 * (total - 1)); }

  function updateUI() {
    const sP = posFromIdx(state.startIdx), eP = posFromIdx(state.endIdx);
    hStart.style.left = sP + '%';
    hEnd.style.left = eP + '%';
    fill.style.left = sP + '%';
    fill.style.width = (eP - sP) + '%';
    tipStart.textContent = mLabel(ALL_MONTHS[state.startIdx]);
    tipEnd.textContent = mLabel(ALL_MONTHS[state.endIdx]);
    summary.textContent = mLabelFull(ALL_MONTHS[state.startIdx]) + '  â†’  ' + mLabelFull(ALL_MONTHS[state.endIdx])
      + '  (' + (state.endIdx - state.startIdx + 1) + ' mois)';
  }

  // â”€â”€ Drag logic â”€â”€
  function startDrag(handle, isEnd) {
    let dragging = false;

    function onMove(e) {
      if (!dragging) return;
      e.preventDefault();
      const rect = track.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      let pct = ((clientX - rect.left) / rect.width) * 100;
      pct = Math.max(0, Math.min(100, pct));
      let idx = idxFromPos(pct);

      if (isEnd) {
        idx = Math.max(state.startIdx + 1, idx);
        state.endIdx = idx;
      } else {
        idx = Math.min(state.endIdx - 1, idx);
        state.startIdx = idx;
      }
      updateUI();
      // Clear preset active
      presetsContainer.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
    }

    function onUp() {
      dragging = false;
      handle.classList.remove('dragging');
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      document.removeEventListener('touchmove', onMove);
      document.removeEventListener('touchend', onUp);
      renderTabCharts(tabName);
    }

    handle.addEventListener('mousedown', (e) => {
      e.preventDefault();
      dragging = true;
      handle.classList.add('dragging');
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    });

    handle.addEventListener('touchstart', (e) => {
      dragging = true;
      handle.classList.add('dragging');
      document.addEventListener('touchmove', onMove, { passive: false });
      document.addEventListener('touchend', onUp);
    });
  }

  startDrag(hStart, false);
  startDrag(hEnd, true);
  updateUI();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const chartInstances = {};

function destroyCharts(prefix) {
  ['eq','ann','mDax','mNas','mComb','r12','dd'].forEach(k => {
    const key = k + prefix;
    if (chartInstances[key]) { chartInstances[key].destroy(); delete chartInstances[key]; }
  });
}

function renderTabCharts(tabName) {
  const suffix = tabName === 'fixed' ? 'Fixed' : 'Reinvest';
  const daxD = tabName === 'fixed' ? fDax : rDax;
  const nasD = tabName === 'fixed' ? fNas : rNas;
  const state = periodState[tabName];
  const slice = getSlice(state.startIdx, state.endIdx);
  const cap = state.capital;

  destroyCharts(suffix);

  buildKPIs('kpi' + suffix, daxD, nasD, slice, cap);
  chartInstances['eq' + suffix] = buildEquity('eq' + suffix, daxD, nasD, slice, cap);
  chartInstances['ann' + suffix] = buildAnnual('ann' + suffix, daxD, nasD, slice);
  chartInstances['mDax' + suffix] = buildMonthlyBar('mDax' + suffix, daxD, slice);
  chartInstances['mNas' + suffix] = buildMonthlyBar('mNas' + suffix, nasD, slice);
  chartInstances['mComb' + suffix] = buildCombinedMonthly('mComb' + suffix, daxD, nasD, slice);
  chartInstances['r12' + suffix] = buildRolling12('r12' + suffix, daxD, nasD, slice);
  chartInstances['dd' + suffix] = buildDrawdown('dd' + suffix, daxD, nasD, slice, cap);

  buildHeatmap('hmDax' + suffix, daxD, slice);
  buildHeatmap('hmNas' + suffix, nasD, slice);
  buildMergedHeatmap('hmMerged' + suffix, daxD, nasD, slice);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAPITAL SLIDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initCapitalSlider(tabName) {
  const suffix = tabName === 'fixed' ? 'Fixed' : 'Reinvest';
  const slider = document.getElementById('capSlider' + suffix);
  const amountEl = document.getElementById('capAmount' + suffix);
  const detailEl = document.getElementById('capDetail' + suffix);
  const ticksEl = document.getElementById('capTicks' + suffix);
  const state = periodState[tabName];

  // Ticks
  const tickValues = [10000, 20000, 30000, 50000, 75000, 100000];
  ticksEl.innerHTML = tickValues.map(v =>
    `<span data-val="${v}" style="cursor:pointer">${fmt(v)} â‚¬</span>`
  ).join('');
  ticksEl.querySelectorAll('span').forEach(s => {
    s.addEventListener('click', () => {
      const v = +s.dataset.val;
      slider.value = v;
      state.capital = v;
      updateCapitalUI();
      renderTabCharts(tabName);
    });
  });

  function updateCapitalUI() {
    const v = state.capital;
    amountEl.textContent = fmt(v) + ' â‚¬';
    detailEl.textContent = 'â†’ ' + fmt(v / 2) + ' â‚¬ par stratÃ©gie';
    // Update slider background fill
    const pct = ((v - 10000) / 90000) * 100;
    slider.style.background = `linear-gradient(90deg, rgba(16,185,129,0.5) ${pct}%, rgba(30,42,58,0.8) ${pct}%)`;
  }

  slider.addEventListener('input', () => {
    state.capital = +slider.value;
    updateCapitalUI();
  });

  slider.addEventListener('change', () => {
    renderTabCharts(tabName);
  });

  updateCapitalUI();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentTab = 'real';
const tabRendered = { real: false, fixed: false, reinvest: false };

function switchTab(tab) {
  if (tab === currentTab) return;
  currentTab = tab;
  const tabNames = ['real', 'fixed', 'reinvest'];
  document.querySelectorAll('.tab-btn').forEach((btn, i) => {
    btn.classList.toggle('active', tabNames[i] === tab);
  });
  tabNames.forEach(t => {
    document.getElementById('tab-' + t).classList.toggle('active', t === tab);
  });
  if (!tabRendered[tab]) {
    if (tab === 'real') {
      renderRealTab();
    } else {
      initCapitalSlider(tab);
      initTimeline(tab);
      renderTabCharts(tab);
    }
    tabRendered[tab] = true;
  }
}

// â”€â”€ INIT â”€â”€
Promise.all([loadTradesFromFirebase(), loadCapitalAdjustments()]).then(() => {
  if (realTrades.length > 0) {
    const latest = [...realTrades].sort((a,b) => b[0].localeCompare(a[0]))[0][0];
    calYear = parseInt(latest.substring(0,4));
    calMonth = parseInt(latest.substring(5,7)) - 1;
  }
  renderRealTab();
  tabRendered.real = true;
});
</script>
</body>
</html>
